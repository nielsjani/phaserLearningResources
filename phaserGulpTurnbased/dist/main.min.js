(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({"d:\\phaserGulpTurnbased\\src\\js\\main.js":[function(require,module,exports){
var RPG = RPG || {};

RPG.game = new Phaser.Game(320, 320, Phaser.CANVAS);
RPG.game.state.add("BootState", require('./states/BootState'));
RPG.game.state.add("LoadingState", require('./states/LoadingState'));
RPG.game.state.add("WorldState", require('./states/WorldState'));
RPG.game.state.add("BattleState", require('./states/BattleState'));
RPG.game.state.start("BootState", true, false, "assets/levels/level1.json", "WorldState", {});
},{"./states/BattleState":"d:\\phaserGulpTurnbased\\src\\js\\states\\BattleState.js","./states/BootState":"d:\\phaserGulpTurnbased\\src\\js\\states\\BootState.js","./states/LoadingState":"d:\\phaserGulpTurnbased\\src\\js\\states\\LoadingState.js","./states/WorldState":"d:\\phaserGulpTurnbased\\src\\js\\states\\WorldState.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\ActionMessage.js":[function(require,module,exports){
var ActionMessage = function () {};


ActionMessage = function (game_state, name, position, properties) {
    "use strict";
    require('./../Prefab').call(this, game_state, name, position, properties);
    
    this.anchor.setTo(0.5);
    
    // create message text
    var textPrefab = require('./../TextPrefab');
    this.message_text = new textPrefab(this.game_state, this.name + "_message", position, {group: "hud", text: properties.message, style: Object.create(this.game_state.TEXT_STYLE)});
    this.message_text.anchor.setTo(0.5);
    
    // start timer to destroy the message
    this.kill_timer = this.game_state.game.time.create();
    this.kill_timer.add(Phaser.Timer.SECOND * properties.duration, this.kill, this);
    this.kill_timer.start();
};

ActionMessage.prototype = Object.create(require('./../Prefab').prototype);
ActionMessage.prototype.constructor = ActionMessage;

ActionMessage.prototype.kill = function () {
    "use strict";
    Phaser.Sprite.prototype.kill.call(this);
    // when the message is destroyed, call next turn
    this.message_text.kill();
    this.game_state.next_turn();
};
module.exports = ActionMessage;

},{"./../Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js","./../TextPrefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\TextPrefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\AttackMenuItem.js":[function(require,module,exports){
var AttackMenuItem = function (game_state, name, position, properties) {
    "use strict";
    require('./MenuItem').call(this, game_state, name, position, properties);
};

AttackMenuItem.prototype = Object.create(require('./MenuItem').prototype);
AttackMenuItem.prototype.constructor = AttackMenuItem;

AttackMenuItem.prototype.select = function () {
    "use strict";
    // disable actions menu
    this.game_state.prefabs.actions_menu.disable();
    // enable enemy units menu so the player can choose the target
    this.game_state.prefabs.enemy_units_menu.enable();
    // save current attack
    var physicalAttack = require('./../Units/PhysicalAttack');
    this.game_state.current_attack = new physicalAttack(this.game_state, this.game_state.current_unit.name + "_attack", {x: 0, y: 0}, {group: "attacks", owner_name: this.game_state.current_unit.name});

};

module.exports = AttackMenuItem;

},{"./../Units/PhysicalAttack":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\PhysicalAttack.js","./MenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MenuItem.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\EnemyMenuItem.js":[function(require,module,exports){
var EnemyMenuItem = function () {};


EnemyMenuItem = function (game_state, name, position, properties) {
    "use strict";
    require('./MenuItem').call(this, game_state, name, position, properties);
};

EnemyMenuItem.prototype = Object.create(require('./MenuItem').prototype);
EnemyMenuItem.prototype.constructor = EnemyMenuItem;

EnemyMenuItem.prototype.select = function () {
    "use strict";
    var enemy;
    // get enemy prefab
    enemy = this.game_state.prefabs[this.text];
    // attack selected enemy
    this.game_state.current_unit.attack(enemy);
    // disable menus
    this.game_state.prefabs.enemy_units_menu.disable();
    this.game_state.prefabs.player_units_menu.disable();
};

module.exports = EnemyMenuItem;

},{"./MenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MenuItem.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\InventoryMenuItem.js":[function(require,module,exports){
var InventoryMenuItem = function (game_state, name, position, properties) {
    "use strict";
    require('./MenuItem').call(this, game_state, name, position, properties);
};

InventoryMenuItem.prototype = Object.create(require('./MenuItem').prototype);
InventoryMenuItem.prototype.constructor = InventoryMenuItem;

InventoryMenuItem.prototype.select = function () {
    "use strict";
    // select only if there are remaining items
    if (this.game_state.prefabs.inventory.items.length > 0) {
        // disable actions menu
        this.game_state.prefabs.actions_menu.disable();
        this.game_state.prefabs.actions_menu.hide();
        // enable enemy units menu so the player can choose the target
        this.game_state.prefabs.items_menu.show();
        this.game_state.prefabs.items_menu.enable();
    }
};

module.exports = InventoryMenuItem;
},{"./MenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MenuItem.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\ItemMenuItem.js":[function(require,module,exports){
var ItemMenuItem = function (game_state, name, position, properties) {
    "use strict";
    require('./MenuItem').call(this, game_state, name, position, properties);
};

ItemMenuItem.prototype = Object.create(require('./MenuItem').prototype);
ItemMenuItem.prototype.constructor = ItemMenuItem;

ItemMenuItem.prototype.select = function () {
    "use strict";
    // disable actions menu
    this.game_state.prefabs.items_menu.disable();
    // enable player units menu so the player can choose the target
    this.game_state.prefabs.player_units_menu.enable();
    // save selected item
    this.game_state.current_item = this.text;
};

module.exports = ItemMenuItem;
},{"./MenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MenuItem.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MagicAttackMenuItem.js":[function(require,module,exports){
var MagicAttackMenuItem = function (game_state, name, position, properties) {
    "use strict";
    require('./MenuItem').call(this, game_state, name, position, properties);
    
    this.MANA_COST = 10;
};

MagicAttackMenuItem.prototype = Object.create(require('./MenuItem').prototype);
MagicAttackMenuItem.prototype.constructor = MagicAttackMenuItem;

MagicAttackMenuItem.prototype.select = function () {
    "use strict";
    // use only if the current unit has enough mana
    if (this.game_state.current_unit.stats.mana >= this.MANA_COST) {
        // disable actions menu
        this.game_state.prefabs.actions_menu.disable();
        // enable enemy units menu so the player can choose the target
        this.game_state.prefabs.enemy_units_menu.enable();
        // save current attack
        var MagicAttack = require('./../Units/MagicAttack');
        this.game_state.current_attack = new MagicAttack(this.game_state, this.game_state.current_unit.name + "_attack", {x: 0, y: 0}, {group: "attacks", mana_cost: this.MANA_COST, owner_name: this.game_state.current_unit.name});
    }
};

module.exports = MagicAttackMenuItem;
},{"./../Units/MagicAttack":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\MagicAttack.js","./MenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MenuItem.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\Menu.js":[function(require,module,exports){
var Menu = function () {};


Menu = function (game_state, name, position, properties) {
    "use strict";
    var live_index, life;
    require('./../Prefab').call(this, game_state, name, position, properties);
    
    this.visible = false;
    
    this.menu_items = properties.menu_items;
    
    this.current_item_index = 0;
};

Menu.prototype = Object.create(require('./../Prefab').prototype);
Menu.prototype.constructor = Menu;

Menu.prototype.process_input = function (event) {
    "use strict";
    switch (event.keyCode) {
    case Phaser.Keyboard.UP:
        if (this.current_item_index > 0) {
            // navigate to previous item
            this.move_selection(this.current_item_index - 1);
        }
        break;
    case Phaser.Keyboard.DOWN:
        if (this.current_item_index < this.menu_items.length - 1) {
            // navigate to next item
            this.move_selection(this.current_item_index + 1);
        }
        break;
    case Phaser.Keyboard.SPACEBAR:
        this.menu_items[this.current_item_index].select();
        break;
    }
};

Menu.prototype.move_selection = function (item_index) {
    "use strict";
    this.menu_items[this.current_item_index].selection_out();
    this.current_item_index = item_index;
    this.menu_items[this.current_item_index].selection_over();
};

Menu.prototype.find_item_index = function (text) {
    "use strict";
    var item_index;
    for (item_index = 0; item_index < this.menu_items.length; item_index += 1) {
        if (this.menu_items[item_index].text === text) {
            return item_index;
        }
    }
};

Menu.prototype.remove_item = function (index) {
    "use strict";
    var menu_item;
    menu_item = this.menu_items[index];
    // remove menu item
    this.menu_items.splice(index, 1);
    // update current_item_index if necessary
    if (this.current_item_index === index) {
        this.current_item_index = 0;
    }
    return menu_item;
};

Menu.prototype.enable = function () {
    "use strict";
    this.current_item_index = 0;
    if (this.menu_items.length > 0) {
        this.menu_items[this.current_item_index].selection_over();
    }
    this.game_state.game.input.keyboard.addCallbacks(this, this.process_input);
};

Menu.prototype.disable = function () {
    "use strict";
    if (this.menu_items.length > 0) {
        this.menu_items[this.current_item_index].selection_out();
    }
    this.current_item_index = 0;
};

Menu.prototype.show = function () {
    "use strict";
    this.menu_items.forEach(function (menu_item) {
        menu_item.visible = true;
    }, this);
};

Menu.prototype.hide = function () {
    "use strict";
    this.menu_items.forEach(function (menu_item) {
        menu_item.visible = false;
    }, this);
};

module.exports = Menu;

},{"./../Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MenuItem.js":[function(require,module,exports){
var MenuItem = function (game_state, name, position, properties) {
    "use strict";
    require('./../TextPrefab').call(this, game_state, name, position, properties);
};

MenuItem.prototype = Object.create(require('./../TextPrefab').prototype);
MenuItem.prototype.constructor = MenuItem;

MenuItem.prototype.selection_over = function () {
    "use strict";
    this.fill = "#FFFF00";
};

MenuItem.prototype.selection_out = function () {
    "use strict";
    this.fill = "#FFFFFF";
};

module.exports = MenuItem;

},{"./../TextPrefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\TextPrefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\PlayerMenuItem.js":[function(require,module,exports){
var PlayerMenuItem  = function (game_state, name, position, properties) {
    "use strict";
    require('./MenuItem').call(this, game_state, name, position, properties);

    var showStat = require('./ShowStat');
    this.player_unit_health = new showStat(this.game_state, this.text + "_health", {x: 280, y: this.y}, {group: "hud", text: "", style: properties.style, prefab: this.text, stat: "health"});
    this.player_unit_mana = new showStat(this.game_state, this.text + "_health", {x: 280, y: this.y}, {group: "hud", text: "", style: properties.style, prefab: this.text, stat: "mana"});
};

PlayerMenuItem.prototype = Object.create(require('./MenuItem').prototype);
PlayerMenuItem.prototype.constructor = PlayerMenuItem;

PlayerMenuItem.prototype.select = function () {
    "use strict";
    var player_unit = this.game_state.prefabs[this.text];
    // use current selected item on selected unit
    this.game_state.prefabs.inventory.use_item(this.game_state.current_item, player_unit);

    // show actions menu again
    this.game_state.prefabs.items_menu.disable();
    this.game_state.prefabs.items_menu.hide();
    this.game_state.prefabs.actions_menu.show();
    this.game_state.prefabs.actions_menu.enable();
};

module.exports = PlayerMenuItem;

},{"./MenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MenuItem.js","./ShowStat":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\ShowStat.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\ShowStat.js":[function(require,module,exports){
var ShowStat = function (game_state, name, position, properties) {
    "use strict";
    require('./../TextPrefab').call(this, game_state, name, position, properties);
    
    this.prefab = this.game_state.prefabs[properties.prefab];
    this.stat = properties.stat;
};

ShowStat.prototype = Object.create(require('./../TextPrefab').prototype);
ShowStat.prototype.constructor = ShowStat;

ShowStat.prototype.update = function () {
    "use strict";
    this.text = this.prefab.stats[this.stat];
};

module.exports = ShowStat;

},{"./../TextPrefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\TextPrefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js":[function(require,module,exports){
var Prefab = function (game_state, name, position, properties) {
    "use strict";
    Phaser.Sprite.call(this, game_state.game, position.x, position.y, properties.texture);

    this.game_state = game_state;

    this.name = name;

    this.game_state.groups[properties.group].add(this);
    this.frame = +properties.frame;

    if (properties.scale) {
        this.scale.setTo(properties.scale.x, properties.scale.y);
    }

    this.game_state.prefabs[name] = this;
};

Prefab.prototype = Object.create(Phaser.Sprite.prototype);
Prefab.prototype.constructor = Prefab;

module.exports = Prefab;
},{}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\TextPrefab.js":[function(require,module,exports){
var TextPrefab  = function (game_state, name, position, properties) {
    "use strict";
    Phaser.Text.call(this, game_state.game, position.x, position.y, properties.text, properties.style);
    
    this.game_state = game_state;
    
    this.name = name;
    
    this.game_state.groups[properties.group].add(this);
    
    this.game_state.prefabs[name] = this;
};

TextPrefab.prototype = Object.create(Phaser.Text.prototype);
TextPrefab.prototype.constructor = TextPrefab;

module.exports = TextPrefab;
},{}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\TilePrefab.js":[function(require,module,exports){
var TilePrefab = function (game_state, name, position, properties) {
    "use strict";
    Phaser.TileSprite.call(this, game_state.game, position.x, position.y, properties.width, properties.height, properties.texture);

    this.game_state = game_state;

    this.name = name;

    this.game_state.groups[properties.group].add(this);
    this.frame = +properties.frame;

    this.game_state.prefabs[name] = this;
};

TilePrefab.prototype = Object.create(Phaser.TileSprite.prototype);
TilePrefab.prototype.constructor = TilePrefab;

module.exports = TilePrefab;

},{}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\Attack.js":[function(require,module,exports){
var Attack = function (game_state, name, position, properties) {
    "use strict";
    require('./../Prefab').call(this, game_state, name, position, properties);
    
    this.owner = this.game_state.prefabs[properties.owner_name];
};

Attack.prototype = Object.create(require('./../Prefab').prototype);
Attack.prototype.constructor = Attack;

Attack.prototype.show_message = function (target, damage) {
    "use strict";
    var action_message_position, action_message_text, attack_message;
    // show attack message
    action_message_position = new Phaser.Point(this.game_state.game.world.width / 2, this.game_state.game.world.height * 0.1);
    action_message_text = this.owner.name + " attacks " + target.name + " with " + damage + " damage";
    var actionMessage = require('./../HUD/ActionMessage');
    attack_message = new actionMessage(this.game_state, this.name + "_action_message", action_message_position, {group: "hud", texture:     "rectangle_image", scale: {x: 0.85, y: 0.2}, duration: 1, message: action_message_text});
};

module.exports = Attack;
},{"./../HUD/ActionMessage":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\ActionMessage.js","./../Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\EnemyUnit.js":[function(require,module,exports){
var EnemyUnit = function (game_state, name, position, properties) {
    "use strict";
    require('./Unit').call(this, game_state, name, position, properties);

    this.anchor.setTo(0.5);

    this.scale.setTo(-1, 1);
};

EnemyUnit.prototype = Object.create(require('./Unit').prototype);
EnemyUnit.prototype.constructor = EnemyUnit;

EnemyUnit.prototype.act = function () {
    "use strict";
    var target_index, target, damage;
    // randomly choose target
    target_index = this.game_state.rnd.between(0, this.game_state.groups.player_units.countLiving() - 1);
    target = this.game_state.groups.player_units.children[target_index];

    this.attack(target);
};

EnemyUnit.prototype.kill = function () {
    "use strict";
    var menu_item_index, menu_item;
    Phaser.Sprite.prototype.kill.call(this);
    // remove from the menu
    menu_item_index = this.game_state.prefabs.enemy_units_menu.find_item_index(this.name);
    menu_item = this.game_state.prefabs.enemy_units_menu.remove_item(menu_item_index);
    menu_item.kill();
};

module.exports = EnemyUnit;
},{"./Unit":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\Unit.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\MagicAttack.js":[function(require,module,exports){
var MagicAttack = function (game_state, name, position, properties) {
    "use strict";
    require('./Attack').call(this, game_state, name, position, properties);
    
    this.mana_cost = properties.mana_cost;
};

MagicAttack.prototype = Object.create(require('./Attack').prototype);
MagicAttack.prototype.constructor = MagicAttack;

MagicAttack.prototype.hit = function (target) {
    "use strict";
    var damage, attack_multiplier, defense_multiplier, action_message_position, action_message_text, attack_message;
    // the attack multiplier for magic attacks is higher
    attack_multiplier = this.game_state.game.rnd.realInRange(0.9, 1.3);
    defense_multiplier = this.game_state.game.rnd.realInRange(0.8, 1.2);
    // calculate damage using the magic attack stat
    damage = Math.max(0, Math.round((attack_multiplier * this.owner.stats.magic_attack) - (defense_multiplier * target.stats.defense)));
    // apply damage
    target.receive_damage(damage);
    
    // reduce the unit mana
    this.game_state.current_unit.stats.mana -= this.mana_cost;
    
    this.show_message(target, damage);
};

module.exports = MagicAttack;
},{"./Attack":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\Attack.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\PhysicalAttack.js":[function(require,module,exports){
var PhysicalAttack = function (game_state, name, position, properties) {
    "use strict";
    require('./Attack').call(this, game_state, name, position, properties);
};

PhysicalAttack.prototype = Object.create(require('./Attack').prototype);
PhysicalAttack.prototype.constructor = PhysicalAttack;

PhysicalAttack.prototype.hit = function (target) {
    "use strict";
    var damage, attack_multiplier, defense_multiplier, action_message_position, action_message_text, attack_message;
    // calculate random attack and defense multipliers
    attack_multiplier = this.game_state.game.rnd.realInRange(0.8, 1.2);
    defense_multiplier = this.game_state.game.rnd.realInRange(0.8, 1.2);
    // calculate damage
    damage = Math.max(0, Math.round((attack_multiplier * this.owner.stats.attack) - (defense_multiplier * target.stats.defense)));
    // apply damage
    target.receive_damage(damage);
    
    this.show_message(target, damage);
};

module.exports = PhysicalAttack;
},{"./Attack":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\Attack.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\PlayerUnit.js":[function(require,module,exports){
var PlayerUnit = function (game_state, name, position, properties) {
    "use strict";
    require('./Unit').call(this, game_state, name, position, properties);

    this.anchor.setTo(0.5);
};

PlayerUnit.prototype = Object.create(require('./Unit').prototype);
PlayerUnit.prototype.constructor = PlayerUnit;

PlayerUnit.prototype.act = function () {
    "use strict";
    var unit_index, player_units_menu_items;
    // search for the index of this unit in the player_units_menu
    unit_index = this.game_state.prefabs.player_units_menu.find_item_index(this.name);
    this.game_state.prefabs.player_units_menu.move_selection(unit_index);

    // enable menu for choosing the action
    this.game_state.prefabs.actions_menu.enable();
};

PlayerUnit.prototype.kill = function () {
    "use strict";
    var menu_item_index, menu_item;
    Phaser.Sprite.prototype.kill.call(this);
    // remove from the menu
    menu_item_index = this.game_state.prefabs.player_units_menu.find_item_index(this.name);
    this.game_state.prefabs.player_units_menu.menu_items[menu_item_index].alpha = 0.5;
};

PlayerUnit.prototype.receive_experience = function (experience) {
    "use strict";
    // increase experience
    this.stats.experience += experience;
    var next_level_data = this.game_state.experience_table[this.stats.current_level];
    // if current experience is greater than the necessary to the next level, the unit gains a level
    if (this.stats.experience >= next_level_data.required_exp) {
        this.stats.current_level += 1;
        this.stats.experience = 0;
        // increase unit stats according to new level
        for (var stat in next_level_data.stats_increase) {
            if (next_level_data.stats_increase.hasOwnProperty(stat)) {
                this.stats[stat] += next_level_data.stats_increase[stat];
            }
        }
    }
};

module.exports = PlayerUnit;
},{"./Unit":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\Unit.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\Unit.js":[function(require,module,exports){
var Unit = function (game_state, name, position, properties) {
    "use strict";
    require('./../Prefab').call(this, game_state, name, position, properties);

    this.anchor.setTo(0.5);

    this.stats = properties.stats;

    this.attacked_animation = this.game_state.game.add.tween(this);
    this.attacked_animation.to({tint: 0xFF0000}, 200);
    this.attacked_animation.onComplete.add(this.restore_tint, this);
};

Unit.prototype = Object.create(require('./../Prefab').prototype);
Unit.prototype.constructor = Unit;

Unit.prototype.calculate_act_turn = function (current_turn) {
    "use strict";
    // calculate the act turn based on the unit speed
    this.act_turn = current_turn + Math.ceil(100 / this.stats.speed);
};

Unit.prototype.receive_damage = function (damage) {
    "use strict";
    this.stats.health -= damage;
    this.attacked_animation.start();
    if (this.stats.health <= 0) {
        this.stats.health = 0;
        this.kill();
    }
};

Unit.prototype.restore_tint = function () {
    "use strict";
    this.tint = 0xFFFFFF;
};

Unit.prototype.attack = function (target) {
    "use strict";
    var damage, attack_multiplier, defense_multiplier, action_message_position, action_message_text, attack_message;
    // attack target
    attack_multiplier = this.game_state.game.rnd.realInRange(0.8, 1.2);
    defense_multiplier = this.game_state.game.rnd.realInRange(0.8, 1.2);
    damage = Math.round((attack_multiplier * this.stats.attack) - (defense_multiplier * target.stats.defense));
    target.receive_damage(damage);

    // show attack message
    action_message_position = new Phaser.Point(this.game_state.game.world.width / 2, this.game_state.game.world.height * 0.1);
    action_message_text = this.name + " attacks " + target.name + " with " + damage + " damage";
    var actionMessage = require('./../HUD/ActionMessage');
    attack_message = new actionMessage(this.game_state, this.name + "_action_message", action_message_position, {
        group: "hud",
        texture: "rectangle_image",
        scale: {x: 0.75, y: 0.2},
        duration: 1,
        message: action_message_text
    });
};

module.exports = Unit;
},{"./../HUD/ActionMessage":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\ActionMessage.js","./../Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\items\\Inventory.js":[function(require,module,exports){
var Inventory = function (game_state, name, position, properties) {
    "use strict";
    require('./../Prefab').call(this, game_state, name, position, properties);
    
    this.item_classes = {
        "potion": require('./Potion').prototype.constructor
    };

    this.items = [];
};

Inventory.prototype = Object.create(require('./../Prefab').prototype);
Inventory.prototype.constructor = Inventory;

Inventory.prototype.create_menu = function (position) {
    "use strict";
    var menu_items, item_index, item, menu_item, items_menu;
    // create units menu items
    item_index = 0;
    menu_items = [];
    for (item_index = 0; item_index < this.items.length; item_index += 1) {
        item = this.items[item_index];
        var itemMenuItem = require('./../HUD/ItemMenuItem');
        menu_item = new itemMenuItem(this.game_state, item.name + "_menu_item", {x: position.x, y: position.y + item_index * 20}, {group: "hud", text: item.name, style: Object.create(this.game_state.TEXT_STYLE)});
        menu_items.push(menu_item);
    }
    // create units menu
    var menu = require('./../HUD/Menu');
    items_menu = new menu(this.game_state, "items_menu", position, {group: "hud", menu_items: menu_items});
    items_menu.hide();
};

Inventory.prototype.collect_item = function (item_object) {
    "use strict";
    var item = new this.item_classes[item_object.type](this.game_state, item_object.type + this.items.length, {x: 0, y: 0}, item_object.properties);
    this.items.push(item);
};

Inventory.prototype.use_item = function (item_name, target) {
    "use strict";
    // remove item from items list
    for (var item_index = 0; item_index < this.items.length; item_index += 1) {
        if (this.items[item_index].name === item_name) {
            this.items[item_index].use(target);
            this.items.splice(item_index, 1);
            break;
        }
    }
};

module.exports = Inventory;

},{"./../HUD/ItemMenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\ItemMenuItem.js","./../HUD/Menu":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\Menu.js","./../Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js","./Potion":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\items\\Potion.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\items\\Item.js":[function(require,module,exports){
var Item = function (game_state, name, position, properties) {
    "use strict";
    require('./../Prefab').call(this, game_state, name, position, properties);
};

Item.prototype = Object.create(require('./../Prefab').prototype);
Item.prototype.constructor = Item;

Item.prototype.use = function () {
    "use strict";
    // by default the item is destroyed
    this.kill();
};

Item.prototype.kill = function () {
    "use strict";
    Phaser.Sprite.prototype.kill.call(this);
    // remove item from the menu
    var menu_item_index = this.game_state.prefabs.items_menu.find_item_index(this.name);
    var menu_item = this.game_state.prefabs.items_menu.remove_item(menu_item_index);
    menu_item.kill();
};

module.exports = Item;
},{"./../Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\items\\Potion.js":[function(require,module,exports){
var Potion = function (game_state, name, position, properties) {
    "use strict";
    require('./Item').call(this, game_state, name, position, properties);
    this.health_power = properties.health_power;
};

Potion.prototype = Object.create(require('./Item').prototype);
Potion.prototype.constructor = Potion;

Potion.prototype.use = function (target) {
    "use strict";
    require('./Item').prototype.use.call(this);
    target.stats.health += this.health_power;
};

module.exports = Potion;
},{"./Item":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\items\\Item.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\world\\EnemySpawner.js":[function(require,module,exports){
var EnemySpawner = function (game_state, name, position, properties) {
    "use strict";
    require('./../Prefab').call(this, game_state, name, position, properties);
    
    this.game_state.game.physics.arcade.enable(this);
    this.body.immovable = true;
    
    this.overlapping = true;
};

EnemySpawner.prototype = Object.create(require('./../Prefab').prototype);
EnemySpawner.prototype.constructor = EnemySpawner;

EnemySpawner.prototype.update = function () {
    "use strict";
    this.overlapping = this.game_state.game.physics.arcade.overlap(this, this.game_state.groups.players, this.check_for_spawn, null, this);
};

EnemySpawner.prototype.check_for_spawn = function () {
    "use strict";
    var spawn_chance, encounter_index, enemy_encounter;
    // check for spawn only once for overlap
    if (!this.overlapping) {
        spawn_chance = this.game_state.game.rnd.frac();
        // check if the enemy spawn probability is less than the generated random number for each spawn
        for (encounter_index = 0; encounter_index < this.game_state.level_data.enemy_encounters.length; encounter_index += 1) {
            enemy_encounter = this.game_state.level_data.enemy_encounters[encounter_index];
            if (spawn_chance <= enemy_encounter.probability) {
                // save current player position for later
                this.game_state.player_position = this.game_state.prefabs.player.position;
                // call battle state
                console.log("TO BATTLE");
                this.game_state.game.state.start("BootState", false, false, "assets/levels/battle.json", "BattleState", {encounter: enemy_encounter, party_data: this.game_state.party_data, inventory: this.game_state.inventory});
                break;
            }
        }
    }
};

module.exports = EnemySpawner;

},{"./../Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\world\\Player.js":[function(require,module,exports){
var Player = function (game_state, name, position, properties) {
    "use strict";
    require('./../Prefab').call(this, game_state, name, position, properties);
    
    this.anchor.setTo(0.5);
    
    this.walking_speed = +properties.walking_speed;
    
    this.animations.add("walking_down", [6, 7, 8], 10, true);
    this.animations.add("walking_left", [9, 10, 11], 10, true);
    this.animations.add("walking_right", [3, 4, 5], 10, true);
    this.animations.add("walking_up", [0, 1, 2], 10, true);
    
    this.stopped_frames = [7, 10, 4, 1, 7];

    this.game_state.game.physics.arcade.enable(this);
    this.body.setSize(16, 16, 0, 8);
    this.body.collideWorldBounds = true;

    this.cursors = this.game_state.game.input.keyboard.createCursorKeys();
};

Player.prototype = Object.create(require('./../Prefab').prototype);
Player.prototype.constructor = Player;

Player.prototype.update = function () {
    "use strict";
    this.game_state.game.physics.arcade.collide(this, this.game_state.layers.collision_back);
    this.game_state.game.physics.arcade.collide(this, this.game_state.layers.collision_front);
    
    if (this.cursors.left.isDown && this.body.velocity.x <= 0) {
        // move left
        this.body.velocity.x = -this.walking_speed;
        if (this.body.velocity.y === 0) {
            this.animations.play("walking_left");
        }
    } else if (this.cursors.right.isDown && this.body.velocity.x >= 0) {
        // move right
        this.body.velocity.x = +this.walking_speed;
        if (this.body.velocity.y === 0) {
            this.animations.play("walking_right");
        }
    } else {
        this.body.velocity.x = 0;
    }

    if (this.cursors.up.isDown && this.body.velocity.y <= 0) {
        // move up
        this.body.velocity.y = -this.walking_speed;
        if (this.body.velocity.x === 0) {
            this.animations.play("walking_up");
        }
    } else if (this.cursors.down.isDown && this.body.velocity.y >= 0) {
        // move down
        this.body.velocity.y = +this.walking_speed;
        if (this.body.velocity.x === 0) {
            this.animations.play("walking_down");
        }
    } else {
        this.body.velocity.y = 0;
    }
    
    if (this.body.velocity.x === 0 && this.body.velocity.y === 0) {
        // stop current animation
        this.animations.stop();
        this.frame = this.stopped_frames[this.body.facing];
    }
};

module.exports = Player;
},{"./../Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js"}],"d:\\phaserGulpTurnbased\\src\\js\\states\\BattleState.js":[function(require,module,exports){
var BattleState = function () {
    "use strict";
    Phaser.State.call(this);

    this.prefab_classes = {
        "background": require('./../prefabs/TilePrefab').prototype.constructor,
        "rectangle": require('./../prefabs/Prefab').prototype.constructor,
        "player_unit": require('./../prefabs/Units/PlayerUnit').prototype.constructor,
        "enemy_unit": require('./../prefabs/Units/EnemyUnit').prototype.constructor,
        "inventory": require('./../prefabs/items/Inventory').prototype.constructor
    };

    this.TEXT_STYLE = {font: "14px Arial", fill: "#FFFFFF"};
};

BattleState.prototype = Object.create(Phaser.State.prototype);
BattleState.prototype.constructor = BattleState;

BattleState.prototype.init = function (level_data, extra_parameters) {
    "use strict";
    console.log("init");
    this.level_data = level_data;
    this.encounter = extra_parameters.encounter;
    this.party_data = extra_parameters.party_data;
    this.inventory = extra_parameters.inventory;


    this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
    this.scale.pageAlignHorizontally = true;
    this.scale.pageAlignVertically = true;
};

BattleState.prototype.preload = function () {
    "use strict";
    console.log("preload");
    this.load.text("experience_table", "assets/levels/experience_table.json");
};

BattleState.prototype.create = function () {
    "use strict";
    console.log("create");
    var group_name, prefab_name, player_unit_name, enemy_unit_name;

    // create groups
    this.groups = {};
    this.level_data.groups.forEach(function (group_name) {
        this.groups[group_name] = this.game.add.group();
    }, this);

    // create prefabs
    this.prefabs = {};
    for (prefab_name in this.level_data.prefabs) {
        if (this.level_data.prefabs.hasOwnProperty(prefab_name)) {
            // create prefab
            this.create_prefab(prefab_name, this.level_data.prefabs[prefab_name]);
        }
    }

    // if there is no inventory from WorldState, create an empty one
    if (this.inventory) {
        this.prefabs.inventory = this.inventory;
    } else {
        var inv = require('./../prefabs/items/Inventory');
        this.prefabs.inventory = new inv(this, "inventory", {x: 0, y: 0}, {group: "items"});
    }

    // create enemy units
    for (enemy_unit_name in this.encounter.enemy_data) {
        if (this.encounter.enemy_data.hasOwnProperty(enemy_unit_name)) {
            // create enemy units
            this.create_prefab(enemy_unit_name, this.encounter.enemy_data[enemy_unit_name]);
        }
    }

    // create player units
    for (player_unit_name in this.party_data) {
        if (this.party_data.hasOwnProperty(player_unit_name)) {
            // create player units
            this.create_prefab(player_unit_name, this.party_data[player_unit_name]);
        }
    }

    // save experience table
    this.experience_table = JSON.parse(this.game.cache.getText("experience_table"));

    this.init_hud();

    // store units in a priority queue which compares the units act turn
    this.units = new PriorityQueue({
        comparator: function (unit_a, unit_b) {
            return unit_a.act_turn - unit_b.act_turn;
        }
    });
    this.groups.player_units.forEach(function (unit) {
        unit.calculate_act_turn(0);
        this.units.queue(unit);
    }, this);
    this.groups.enemy_units.forEach(function (unit) {
        unit.calculate_act_turn(0);
        this.units.queue(unit);
    }, this);

    this.next_turn();
};

BattleState.prototype.create_prefab = function (prefab_name, prefab_data) {
    "use strict";
    var prefab;
    // create object according to its type
    if (this.prefab_classes.hasOwnProperty(prefab_data.type)) {
        prefab = new this.prefab_classes[prefab_data.type](this, prefab_name, prefab_data.position, prefab_data.properties);
    }
};

BattleState.prototype.init_hud = function () {
    "use strict";
    var unit_index, player_unit_health;

    // show player actions
    this.show_player_actions({x: 106, y: 210});

    // show player units
    this.show_units("player_units", {x: 202, y: 210}, require('./../prefabs/HUD/PlayerMenuItem').prototype.constructor);

    // show enemy units
    this.show_units("enemy_units", {x: 10, y: 210}, require('./../prefabs/HUD/EnemyMenuItem').prototype.constructor);

    // create items menu
    this.prefabs.inventory.create_menu({x: 106, y: 210});
};

BattleState.prototype.show_units = function (group_name, position, menu_item_constructor) {
    "use strict";
    var unit_index, menu_items, unit_menu_item, units_menu;

    // create units menu items
    unit_index = 0;
    menu_items = [];
    this.groups[group_name].forEach(function (unit) {
        unit_menu_item = new menu_item_constructor(this, unit.name + "_menu_item", {
            x: position.x,
            y: position.y + unit_index * 20
        }, {group: "hud", text: unit.name, style: Object.create(this.TEXT_STYLE)});
        unit_index += 1;
        menu_items.push(unit_menu_item);
    }, this);
    // create units menu
    var menu = require('./../prefabs/HUD/Menu');
    units_menu = new menu(this, group_name + "_menu", position, {group: "hud", menu_items: menu_items});
};

BattleState.prototype.show_player_actions = function (position) {
    "use strict";
    var actions, actions_menu_items, action_index, actions_menu;
    // available actions
    actions = [
        {text: "Attack", item_constructor: require('./../prefabs/HUD/AttackMenuItem').prototype.constructor},
        {text: "Magic", item_constructor: require('./../prefabs/HUD/MagicAttackMenuItem').prototype.constructor},
        {text: "Item", item_constructor: require('./../prefabs/HUD/InventoryMenuItem').prototype.constructor}
    ];
    actions_menu_items = [];
    action_index = 0;
    // create a menu item for each action
    actions.forEach(function (action) {
        actions_menu_items.push(new action.item_constructor(this, action.text + "_menu_item", {
            x: position.x,
            y: position.y + action_index * 20
        }, {group: "hud", text: action.text, style: Object.create(this.TEXT_STYLE)}));
        action_index += 1;
    }, this);
    var menu = require('./../prefabs/HUD/Menu');
    actions_menu = new menu(this, "actions_menu", position, {group: "hud", menu_items: actions_menu_items});
};

BattleState.prototype.next_turn = function () {
    "use strict";
    // if all enemy units are dead, go back to the world state
    console.log(this.groups);
    if (this.groups.enemy_units.countLiving() === 0) {
        this.end_battle();
    }

    // if all player units are dead, restart the game
    if (this.groups.player_units.countLiving() === 0) {
        this.game_over();
    }

    // takes the next unit
    this.current_unit = this.units.dequeue();
    // if the unit is alive, it acts, otherwise goes to the next turn
    if (this.current_unit.alive) {
        this.current_unit.act();
        this.current_unit.calculate_act_turn(this.current_unit.act_turn);
        this.units.queue(this.current_unit);
    } else {
        this.next_turn();
    }
};

BattleState.prototype.game_over = function () {
    "use strict";
    console.log("GAME_OVER");
    // go back to WorldState restarting the player position
    this.game.state.start("BootState", true, false, "assets/levels/level1.json", "WorldState", {restart_position: true});
};

BattleState.prototype.end_battle = function () {
    "use strict";
    var received_experience = this.encounter.reward.experience;
    this.groups.player_units.forEach(function (player_unit) {
        // receive experience from enemy
        player_unit.receive_experience(received_experience / this.groups.player_units.children.length);
        // save current party stats
        this.party_data[player_unit.name].properties.stats = player_unit.stats;
    }, this);


    this.encounter.reward.items.forEach(function (item_object) {
        this.prefabs.inventory.collect_item(item_object);
    }, this);

    console.log("BATTLE WON");
    // go back to WorldState with the current party data
    this.game.state.start("BootState", true, false, "assets/levels/level1.json", "WorldState", {
        party_data: this.party_data,
        inventory: this.prefabs.inventory
    });
};

module.exports = BattleState;

},{"./../prefabs/HUD/AttackMenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\AttackMenuItem.js","./../prefabs/HUD/EnemyMenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\EnemyMenuItem.js","./../prefabs/HUD/InventoryMenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\InventoryMenuItem.js","./../prefabs/HUD/MagicAttackMenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\MagicAttackMenuItem.js","./../prefabs/HUD/Menu":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\Menu.js","./../prefabs/HUD/PlayerMenuItem":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\HUD\\PlayerMenuItem.js","./../prefabs/Prefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Prefab.js","./../prefabs/TilePrefab":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\TilePrefab.js","./../prefabs/Units/EnemyUnit":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\EnemyUnit.js","./../prefabs/Units/PlayerUnit":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\Units\\PlayerUnit.js","./../prefabs/items/Inventory":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\items\\Inventory.js"}],"d:\\phaserGulpTurnbased\\src\\js\\states\\BootState.js":[function(require,module,exports){
var BootState = function () {
    "use strict";
    Phaser.State.call(this);
};

BootState.prototype = Object.create(Phaser.State.prototype);
BootState.prototype.constructor = BootState;

BootState.prototype.init = function (level_file, next_state, extra_parameters) {
    "use strict";
    this.level_file = level_file;
    this.next_state = next_state;
    this.extra_parameters = extra_parameters;
};

BootState.prototype.preload = function () {
    "use strict";
    this.load.text("level1", this.level_file);
};

BootState.prototype.create = function () {
    "use strict";
    var level_text = this.game.cache.getText("level1");
    var level_data = JSON.parse(level_text);
    this.game.state.start("LoadingState", true, false, level_data, this.next_state, this.extra_parameters);
};

module.exports = BootState;

},{}],"d:\\phaserGulpTurnbased\\src\\js\\states\\LoadingState.js":[function(require,module,exports){
var LoadingState = function () {};


LoadingState = function () {
    "use strict";
    Phaser.State.call(this);
};

LoadingState.prototype = Object.create(Phaser.State.prototype);
LoadingState.prototype.constructor = LoadingState;

LoadingState.prototype.init = function (level_data, next_state, extra_parameters) {
    "use strict";
    this.level_data = level_data;
    this.next_state = next_state;
    this.extra_parameters = extra_parameters;
};

LoadingState.prototype.preload = function () {
    "use strict";
    var assets = this.level_data.assets;
    for (var asset_key in assets) { // load assets according to asset key
        if (assets.hasOwnProperty(asset_key)) {
            var asset = assets[asset_key];
            switch (asset.type) {
            case "image":
                this.load.image(asset_key, asset.source);
                break;
            case "spritesheet":
                this.load.spritesheet(asset_key, asset.source, asset.frame_width, asset.frame_height, asset.frames, asset.margin, asset.spacing);
                break;
            case "tilemap":
                this.load.tilemap(asset_key, asset.source, null, Phaser.Tilemap.TILED_JSON);
                break;
            }
        }
    }
};

LoadingState.prototype.create = function () {
    "use strict";
    this.game.state.start(this.next_state, true, false, this.level_data, this.extra_parameters);
};

module.exports = LoadingState;

},{}],"d:\\phaserGulpTurnbased\\src\\js\\states\\WorldState.js":[function(require,module,exports){
var WorldState = function () {
    "use strict";
    Phaser.State.call(this);

    this.prefab_classes = {
        "player": require('./../prefabs/world/Player').prototype.constructor,
        "enemy_spawner": require('./../prefabs/world/EnemySpawner').prototype.constructor
    };
};

WorldState.prototype = Object.create(Phaser.State.prototype);
WorldState.prototype.constructor = WorldState;

WorldState.prototype.init = function (level_data, extra_parameters) {
    "use strict";
    var tileset_index;
    this.level_data = this.level_data || level_data;

    this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
    this.scale.pageAlignHorizontally = true;
    this.scale.pageAlignVertically = true;

    // start physics system
    this.game.physics.startSystem(Phaser.Physics.ARCADE);
    this.game.physics.arcade.gravity.y = 0;

    // create map and set tileset
    this.map = this.game.add.tilemap(this.level_data.map.key);
    tileset_index = 0;
    this.map.tilesets.forEach(function (tileset) {
        this.map.addTilesetImage(tileset.name, this.level_data.map.tilesets[tileset_index]);
        tileset_index += 1;
    }, this);

    // if no party data is in the parameters, initialize it with default values
    this.party_data = extra_parameters.party_data || {
            "fighter": {
                "type": "player_unit",
                "position": {"x": 250, "y": 50},
                "properties": {
                    "texture": "male_fighter_spritesheet",
                    "group": "player_units",
                    "frame": 10,
                    "stats": {
                        "attack": 20,
                        "magic_attack": 5,
                        "defense": 5,
                        "health": 100,
                        "mana": 100,
                        "speed": 15,
                        "experience": 0,
                        "current_level": 0
                    }
                }
            },
            "mage": {
                "type": "player_unit",
                "position": {"x": 250, "y": 100},
                "properties": {
                    "texture": "female_mage_spritesheet",
                    "group": "player_units",
                    "frame": 10,
                    "stats": {
                        "attack": 5,
                        "magic_attack": 20,
                        "defense": 2,
                        "health": 100,
                        "mana": 100,
                        "speed": 10,
                        "experience": 0,
                        "current_level": 0
                    }
                }
            },
            "ranger": {
                "type": "player_unit",
                "position": {"x": 250, "y": 150},
                "properties": {
                    "texture": "female_ranger_spritesheet",
                    "group": "player_units",
                    "frame": 10,
                    "stats": {
                        "attack": 10,
                        "magic_attack": 10,
                        "defense": 3,
                        "health": 100,
                        "mana": 100,
                        "speed": 20,
                        "experience": 0,
                        "current_level": 0
                    }
                }
            }
        };

    if (extra_parameters.restart_position) {
        this.player_position = undefined;
    }
};

WorldState.prototype.create = function () {
    "use strict";
    var group_name, object_layer, collision_tiles;

    // create map layers
    this.layers = {};
    this.map.layers.forEach(function (layer) {
        this.layers[layer.name] = this.map.createLayer(layer.name);
        if (layer.properties.collision) { // collision layer
            collision_tiles = [];
            layer.data.forEach(function (data_row) { // find tiles used in the layer
                data_row.forEach(function (tile) {
                    // check if it's a valid tile index and isn't already in the list
                    if (tile.index > 0 && collision_tiles.indexOf(tile.index) === -1) {
                        collision_tiles.push(tile.index);
                    }
                }, this);
            }, this);
            this.map.setCollision(collision_tiles, true, layer.name);
        }
    }, this);
    // resize the world to be the size of the current layer
    this.layers[this.map.layer.name].resizeWorld();

    // create groups
    this.groups = {};
    this.level_data.groups.forEach(function (group_name) {
        this.groups[group_name] = this.game.add.group();
    }, this);

    this.prefabs = {};

    for (object_layer in this.map.objects) {
        if (this.map.objects.hasOwnProperty(object_layer)) {
            // create layer objects
            this.map.objects[object_layer].forEach(this.create_object, this);
        }
    }

    // if we came from BattleState, move the player to the previous position
    if (this.player_position) {
        this.prefabs.player.reset(this.player_position.x, this.player_position.y);
    }
};

WorldState.prototype.create_object = function (object) {
    "use strict";
    var object_y, position, prefab;
    // tiled coordinates starts in the bottom left corner
    object_y = (object.gid) ? object.y - (this.map.tileHeight / 2) : object.y + (object.height / 2);
    position = {"x": object.x + (this.map.tileHeight / 2), "y": object_y};
    // create object according to its type
    if (this.prefab_classes.hasOwnProperty(object.type)) {
        prefab = new this.prefab_classes[object.type](this, object.name, position, object.properties);
    }
    this.prefabs[object.name] = prefab;
};

module.exports = WorldState;


},{"./../prefabs/world/EnemySpawner":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\world\\EnemySpawner.js","./../prefabs/world/Player":"d:\\phaserGulpTurnbased\\src\\js\\prefabs\\world\\Player.js"}]},{},["d:\\phaserGulpTurnbased\\src\\js\\main.js"])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvanMvbWFpbi5qcyIsInNyYy9qcy9wcmVmYWJzL0hVRC9BY3Rpb25NZXNzYWdlLmpzIiwic3JjL2pzL3ByZWZhYnMvSFVEL0F0dGFja01lbnVJdGVtLmpzIiwic3JjL2pzL3ByZWZhYnMvSFVEL0VuZW15TWVudUl0ZW0uanMiLCJzcmMvanMvcHJlZmFicy9IVUQvSW52ZW50b3J5TWVudUl0ZW0uanMiLCJzcmMvanMvcHJlZmFicy9IVUQvSXRlbU1lbnVJdGVtLmpzIiwic3JjL2pzL3ByZWZhYnMvSFVEL01hZ2ljQXR0YWNrTWVudUl0ZW0uanMiLCJzcmMvanMvcHJlZmFicy9IVUQvTWVudS5qcyIsInNyYy9qcy9wcmVmYWJzL0hVRC9NZW51SXRlbS5qcyIsInNyYy9qcy9wcmVmYWJzL0hVRC9QbGF5ZXJNZW51SXRlbS5qcyIsInNyYy9qcy9wcmVmYWJzL0hVRC9TaG93U3RhdC5qcyIsInNyYy9qcy9wcmVmYWJzL1ByZWZhYi5qcyIsInNyYy9qcy9wcmVmYWJzL1RleHRQcmVmYWIuanMiLCJzcmMvanMvcHJlZmFicy9UaWxlUHJlZmFiLmpzIiwic3JjL2pzL3ByZWZhYnMvVW5pdHMvQXR0YWNrLmpzIiwic3JjL2pzL3ByZWZhYnMvVW5pdHMvRW5lbXlVbml0LmpzIiwic3JjL2pzL3ByZWZhYnMvVW5pdHMvTWFnaWNBdHRhY2suanMiLCJzcmMvanMvcHJlZmFicy9Vbml0cy9QaHlzaWNhbEF0dGFjay5qcyIsInNyYy9qcy9wcmVmYWJzL1VuaXRzL1BsYXllclVuaXQuanMiLCJzcmMvanMvcHJlZmFicy9Vbml0cy9Vbml0LmpzIiwic3JjL2pzL3ByZWZhYnMvaXRlbXMvSW52ZW50b3J5LmpzIiwic3JjL2pzL3ByZWZhYnMvaXRlbXMvSXRlbS5qcyIsInNyYy9qcy9wcmVmYWJzL2l0ZW1zL1BvdGlvbi5qcyIsInNyYy9qcy9wcmVmYWJzL3dvcmxkL0VuZW15U3Bhd25lci5qcyIsInNyYy9qcy9wcmVmYWJzL3dvcmxkL1BsYXllci5qcyIsInNyYy9qcy9zdGF0ZXMvQmF0dGxlU3RhdGUuanMiLCJzcmMvanMvc3RhdGVzL0Jvb3RTdGF0ZS5qcyIsInNyYy9qcy9zdGF0ZXMvTG9hZGluZ1N0YXRlLmpzIiwic3JjL2pzL3N0YXRlcy9Xb3JsZFN0YXRlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNQQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQy9CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNyQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDeEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3JCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNsQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDeEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNyR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNuQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzFCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDakJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3JCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2hCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNsQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3BCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDaENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzNCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3RCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNoREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzNEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNuREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3ZCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNmQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNyRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3RPQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzVCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM3Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCJ2YXIgUlBHID0gUlBHIHx8IHt9O1xuXG5SUEcuZ2FtZSA9IG5ldyBQaGFzZXIuR2FtZSgzMjAsIDMyMCwgUGhhc2VyLkNBTlZBUyk7XG5SUEcuZ2FtZS5zdGF0ZS5hZGQoXCJCb290U3RhdGVcIiwgcmVxdWlyZSgnLi9zdGF0ZXMvQm9vdFN0YXRlJykpO1xuUlBHLmdhbWUuc3RhdGUuYWRkKFwiTG9hZGluZ1N0YXRlXCIsIHJlcXVpcmUoJy4vc3RhdGVzL0xvYWRpbmdTdGF0ZScpKTtcblJQRy5nYW1lLnN0YXRlLmFkZChcIldvcmxkU3RhdGVcIiwgcmVxdWlyZSgnLi9zdGF0ZXMvV29ybGRTdGF0ZScpKTtcblJQRy5nYW1lLnN0YXRlLmFkZChcIkJhdHRsZVN0YXRlXCIsIHJlcXVpcmUoJy4vc3RhdGVzL0JhdHRsZVN0YXRlJykpO1xuUlBHLmdhbWUuc3RhdGUuc3RhcnQoXCJCb290U3RhdGVcIiwgdHJ1ZSwgZmFsc2UsIFwiYXNzZXRzL2xldmVscy9sZXZlbDEuanNvblwiLCBcIldvcmxkU3RhdGVcIiwge30pOyIsInZhciBBY3Rpb25NZXNzYWdlID0gZnVuY3Rpb24gKCkge307XG5cblxuQWN0aW9uTWVzc2FnZSA9IGZ1bmN0aW9uIChnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHJlcXVpcmUoJy4vLi4vUHJlZmFiJykuY2FsbCh0aGlzLCBnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcyk7XG4gICAgXG4gICAgdGhpcy5hbmNob3Iuc2V0VG8oMC41KTtcbiAgICBcbiAgICAvLyBjcmVhdGUgbWVzc2FnZSB0ZXh0XG4gICAgdmFyIHRleHRQcmVmYWIgPSByZXF1aXJlKCcuLy4uL1RleHRQcmVmYWInKTtcbiAgICB0aGlzLm1lc3NhZ2VfdGV4dCA9IG5ldyB0ZXh0UHJlZmFiKHRoaXMuZ2FtZV9zdGF0ZSwgdGhpcy5uYW1lICsgXCJfbWVzc2FnZVwiLCBwb3NpdGlvbiwge2dyb3VwOiBcImh1ZFwiLCB0ZXh0OiBwcm9wZXJ0aWVzLm1lc3NhZ2UsIHN0eWxlOiBPYmplY3QuY3JlYXRlKHRoaXMuZ2FtZV9zdGF0ZS5URVhUX1NUWUxFKX0pO1xuICAgIHRoaXMubWVzc2FnZV90ZXh0LmFuY2hvci5zZXRUbygwLjUpO1xuICAgIFxuICAgIC8vIHN0YXJ0IHRpbWVyIHRvIGRlc3Ryb3kgdGhlIG1lc3NhZ2VcbiAgICB0aGlzLmtpbGxfdGltZXIgPSB0aGlzLmdhbWVfc3RhdGUuZ2FtZS50aW1lLmNyZWF0ZSgpO1xuICAgIHRoaXMua2lsbF90aW1lci5hZGQoUGhhc2VyLlRpbWVyLlNFQ09ORCAqIHByb3BlcnRpZXMuZHVyYXRpb24sIHRoaXMua2lsbCwgdGhpcyk7XG4gICAgdGhpcy5raWxsX3RpbWVyLnN0YXJ0KCk7XG59O1xuXG5BY3Rpb25NZXNzYWdlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocmVxdWlyZSgnLi8uLi9QcmVmYWInKS5wcm90b3R5cGUpO1xuQWN0aW9uTWVzc2FnZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBY3Rpb25NZXNzYWdlO1xuXG5BY3Rpb25NZXNzYWdlLnByb3RvdHlwZS5raWxsID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIFBoYXNlci5TcHJpdGUucHJvdG90eXBlLmtpbGwuY2FsbCh0aGlzKTtcbiAgICAvLyB3aGVuIHRoZSBtZXNzYWdlIGlzIGRlc3Ryb3llZCwgY2FsbCBuZXh0IHR1cm5cbiAgICB0aGlzLm1lc3NhZ2VfdGV4dC5raWxsKCk7XG4gICAgdGhpcy5nYW1lX3N0YXRlLm5leHRfdHVybigpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQWN0aW9uTWVzc2FnZTtcbiIsInZhciBBdHRhY2tNZW51SXRlbSA9IGZ1bmN0aW9uIChnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHJlcXVpcmUoJy4vTWVudUl0ZW0nKS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKTtcbn07XG5cbkF0dGFja01lbnVJdGVtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocmVxdWlyZSgnLi9NZW51SXRlbScpLnByb3RvdHlwZSk7XG5BdHRhY2tNZW51SXRlbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBdHRhY2tNZW51SXRlbTtcblxuQXR0YWNrTWVudUl0ZW0ucHJvdG90eXBlLnNlbGVjdCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICAvLyBkaXNhYmxlIGFjdGlvbnMgbWVudVxuICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLmFjdGlvbnNfbWVudS5kaXNhYmxlKCk7XG4gICAgLy8gZW5hYmxlIGVuZW15IHVuaXRzIG1lbnUgc28gdGhlIHBsYXllciBjYW4gY2hvb3NlIHRoZSB0YXJnZXRcbiAgICB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5lbmVteV91bml0c19tZW51LmVuYWJsZSgpO1xuICAgIC8vIHNhdmUgY3VycmVudCBhdHRhY2tcbiAgICB2YXIgcGh5c2ljYWxBdHRhY2sgPSByZXF1aXJlKCcuLy4uL1VuaXRzL1BoeXNpY2FsQXR0YWNrJyk7XG4gICAgdGhpcy5nYW1lX3N0YXRlLmN1cnJlbnRfYXR0YWNrID0gbmV3IHBoeXNpY2FsQXR0YWNrKHRoaXMuZ2FtZV9zdGF0ZSwgdGhpcy5nYW1lX3N0YXRlLmN1cnJlbnRfdW5pdC5uYW1lICsgXCJfYXR0YWNrXCIsIHt4OiAwLCB5OiAwfSwge2dyb3VwOiBcImF0dGFja3NcIiwgb3duZXJfbmFtZTogdGhpcy5nYW1lX3N0YXRlLmN1cnJlbnRfdW5pdC5uYW1lfSk7XG5cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gQXR0YWNrTWVudUl0ZW07XG4iLCJ2YXIgRW5lbXlNZW51SXRlbSA9IGZ1bmN0aW9uICgpIHt9O1xuXG5cbkVuZW15TWVudUl0ZW0gPSBmdW5jdGlvbiAoZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXF1aXJlKCcuL01lbnVJdGVtJykuY2FsbCh0aGlzLCBnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcyk7XG59O1xuXG5FbmVteU1lbnVJdGVtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocmVxdWlyZSgnLi9NZW51SXRlbScpLnByb3RvdHlwZSk7XG5FbmVteU1lbnVJdGVtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEVuZW15TWVudUl0ZW07XG5cbkVuZW15TWVudUl0ZW0ucHJvdG90eXBlLnNlbGVjdCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgZW5lbXk7XG4gICAgLy8gZ2V0IGVuZW15IHByZWZhYlxuICAgIGVuZW15ID0gdGhpcy5nYW1lX3N0YXRlLnByZWZhYnNbdGhpcy50ZXh0XTtcbiAgICAvLyBhdHRhY2sgc2VsZWN0ZWQgZW5lbXlcbiAgICB0aGlzLmdhbWVfc3RhdGUuY3VycmVudF91bml0LmF0dGFjayhlbmVteSk7XG4gICAgLy8gZGlzYWJsZSBtZW51c1xuICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLmVuZW15X3VuaXRzX21lbnUuZGlzYWJsZSgpO1xuICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLnBsYXllcl91bml0c19tZW51LmRpc2FibGUoKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gRW5lbXlNZW51SXRlbTtcbiIsInZhciBJbnZlbnRvcnlNZW51SXRlbSA9IGZ1bmN0aW9uIChnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHJlcXVpcmUoJy4vTWVudUl0ZW0nKS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKTtcbn07XG5cbkludmVudG9yeU1lbnVJdGVtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocmVxdWlyZSgnLi9NZW51SXRlbScpLnByb3RvdHlwZSk7XG5JbnZlbnRvcnlNZW51SXRlbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBJbnZlbnRvcnlNZW51SXRlbTtcblxuSW52ZW50b3J5TWVudUl0ZW0ucHJvdG90eXBlLnNlbGVjdCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICAvLyBzZWxlY3Qgb25seSBpZiB0aGVyZSBhcmUgcmVtYWluaW5nIGl0ZW1zXG4gICAgaWYgKHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLmludmVudG9yeS5pdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIGRpc2FibGUgYWN0aW9ucyBtZW51XG4gICAgICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLmFjdGlvbnNfbWVudS5kaXNhYmxlKCk7XG4gICAgICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLmFjdGlvbnNfbWVudS5oaWRlKCk7XG4gICAgICAgIC8vIGVuYWJsZSBlbmVteSB1bml0cyBtZW51IHNvIHRoZSBwbGF5ZXIgY2FuIGNob29zZSB0aGUgdGFyZ2V0XG4gICAgICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLml0ZW1zX21lbnUuc2hvdygpO1xuICAgICAgICB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5pdGVtc19tZW51LmVuYWJsZSgpO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gSW52ZW50b3J5TWVudUl0ZW07IiwidmFyIEl0ZW1NZW51SXRlbSA9IGZ1bmN0aW9uIChnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHJlcXVpcmUoJy4vTWVudUl0ZW0nKS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKTtcbn07XG5cbkl0ZW1NZW51SXRlbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHJlcXVpcmUoJy4vTWVudUl0ZW0nKS5wcm90b3R5cGUpO1xuSXRlbU1lbnVJdGVtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEl0ZW1NZW51SXRlbTtcblxuSXRlbU1lbnVJdGVtLnByb3RvdHlwZS5zZWxlY3QgPSBmdW5jdGlvbiAoKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgLy8gZGlzYWJsZSBhY3Rpb25zIG1lbnVcbiAgICB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5pdGVtc19tZW51LmRpc2FibGUoKTtcbiAgICAvLyBlbmFibGUgcGxheWVyIHVuaXRzIG1lbnUgc28gdGhlIHBsYXllciBjYW4gY2hvb3NlIHRoZSB0YXJnZXRcbiAgICB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5wbGF5ZXJfdW5pdHNfbWVudS5lbmFibGUoKTtcbiAgICAvLyBzYXZlIHNlbGVjdGVkIGl0ZW1cbiAgICB0aGlzLmdhbWVfc3RhdGUuY3VycmVudF9pdGVtID0gdGhpcy50ZXh0O1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBJdGVtTWVudUl0ZW07IiwidmFyIE1hZ2ljQXR0YWNrTWVudUl0ZW0gPSBmdW5jdGlvbiAoZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXF1aXJlKCcuL01lbnVJdGVtJykuY2FsbCh0aGlzLCBnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcyk7XG4gICAgXG4gICAgdGhpcy5NQU5BX0NPU1QgPSAxMDtcbn07XG5cbk1hZ2ljQXR0YWNrTWVudUl0ZW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuL01lbnVJdGVtJykucHJvdG90eXBlKTtcbk1hZ2ljQXR0YWNrTWVudUl0ZW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTWFnaWNBdHRhY2tNZW51SXRlbTtcblxuTWFnaWNBdHRhY2tNZW51SXRlbS5wcm90b3R5cGUuc2VsZWN0ID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIC8vIHVzZSBvbmx5IGlmIHRoZSBjdXJyZW50IHVuaXQgaGFzIGVub3VnaCBtYW5hXG4gICAgaWYgKHRoaXMuZ2FtZV9zdGF0ZS5jdXJyZW50X3VuaXQuc3RhdHMubWFuYSA+PSB0aGlzLk1BTkFfQ09TVCkge1xuICAgICAgICAvLyBkaXNhYmxlIGFjdGlvbnMgbWVudVxuICAgICAgICB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5hY3Rpb25zX21lbnUuZGlzYWJsZSgpO1xuICAgICAgICAvLyBlbmFibGUgZW5lbXkgdW5pdHMgbWVudSBzbyB0aGUgcGxheWVyIGNhbiBjaG9vc2UgdGhlIHRhcmdldFxuICAgICAgICB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5lbmVteV91bml0c19tZW51LmVuYWJsZSgpO1xuICAgICAgICAvLyBzYXZlIGN1cnJlbnQgYXR0YWNrXG4gICAgICAgIHZhciBNYWdpY0F0dGFjayA9IHJlcXVpcmUoJy4vLi4vVW5pdHMvTWFnaWNBdHRhY2snKTtcbiAgICAgICAgdGhpcy5nYW1lX3N0YXRlLmN1cnJlbnRfYXR0YWNrID0gbmV3IE1hZ2ljQXR0YWNrKHRoaXMuZ2FtZV9zdGF0ZSwgdGhpcy5nYW1lX3N0YXRlLmN1cnJlbnRfdW5pdC5uYW1lICsgXCJfYXR0YWNrXCIsIHt4OiAwLCB5OiAwfSwge2dyb3VwOiBcImF0dGFja3NcIiwgbWFuYV9jb3N0OiB0aGlzLk1BTkFfQ09TVCwgb3duZXJfbmFtZTogdGhpcy5nYW1lX3N0YXRlLmN1cnJlbnRfdW5pdC5uYW1lfSk7XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBNYWdpY0F0dGFja01lbnVJdGVtOyIsInZhciBNZW51ID0gZnVuY3Rpb24gKCkge307XG5cblxuTWVudSA9IGZ1bmN0aW9uIChnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBsaXZlX2luZGV4LCBsaWZlO1xuICAgIHJlcXVpcmUoJy4vLi4vUHJlZmFiJykuY2FsbCh0aGlzLCBnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcyk7XG4gICAgXG4gICAgdGhpcy52aXNpYmxlID0gZmFsc2U7XG4gICAgXG4gICAgdGhpcy5tZW51X2l0ZW1zID0gcHJvcGVydGllcy5tZW51X2l0ZW1zO1xuICAgIFxuICAgIHRoaXMuY3VycmVudF9pdGVtX2luZGV4ID0gMDtcbn07XG5cbk1lbnUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuLy4uL1ByZWZhYicpLnByb3RvdHlwZSk7XG5NZW51LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE1lbnU7XG5cbk1lbnUucHJvdG90eXBlLnByb2Nlc3NfaW5wdXQgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBzd2l0Y2ggKGV2ZW50LmtleUNvZGUpIHtcbiAgICBjYXNlIFBoYXNlci5LZXlib2FyZC5VUDpcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudF9pdGVtX2luZGV4ID4gMCkge1xuICAgICAgICAgICAgLy8gbmF2aWdhdGUgdG8gcHJldmlvdXMgaXRlbVxuICAgICAgICAgICAgdGhpcy5tb3ZlX3NlbGVjdGlvbih0aGlzLmN1cnJlbnRfaXRlbV9pbmRleCAtIDEpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIGNhc2UgUGhhc2VyLktleWJvYXJkLkRPV046XG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRfaXRlbV9pbmRleCA8IHRoaXMubWVudV9pdGVtcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAvLyBuYXZpZ2F0ZSB0byBuZXh0IGl0ZW1cbiAgICAgICAgICAgIHRoaXMubW92ZV9zZWxlY3Rpb24odGhpcy5jdXJyZW50X2l0ZW1faW5kZXggKyAxKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICBjYXNlIFBoYXNlci5LZXlib2FyZC5TUEFDRUJBUjpcbiAgICAgICAgdGhpcy5tZW51X2l0ZW1zW3RoaXMuY3VycmVudF9pdGVtX2luZGV4XS5zZWxlY3QoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxufTtcblxuTWVudS5wcm90b3R5cGUubW92ZV9zZWxlY3Rpb24gPSBmdW5jdGlvbiAoaXRlbV9pbmRleCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHRoaXMubWVudV9pdGVtc1t0aGlzLmN1cnJlbnRfaXRlbV9pbmRleF0uc2VsZWN0aW9uX291dCgpO1xuICAgIHRoaXMuY3VycmVudF9pdGVtX2luZGV4ID0gaXRlbV9pbmRleDtcbiAgICB0aGlzLm1lbnVfaXRlbXNbdGhpcy5jdXJyZW50X2l0ZW1faW5kZXhdLnNlbGVjdGlvbl9vdmVyKCk7XG59O1xuXG5NZW51LnByb3RvdHlwZS5maW5kX2l0ZW1faW5kZXggPSBmdW5jdGlvbiAodGV4dCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBpdGVtX2luZGV4O1xuICAgIGZvciAoaXRlbV9pbmRleCA9IDA7IGl0ZW1faW5kZXggPCB0aGlzLm1lbnVfaXRlbXMubGVuZ3RoOyBpdGVtX2luZGV4ICs9IDEpIHtcbiAgICAgICAgaWYgKHRoaXMubWVudV9pdGVtc1tpdGVtX2luZGV4XS50ZXh0ID09PSB0ZXh0KSB7XG4gICAgICAgICAgICByZXR1cm4gaXRlbV9pbmRleDtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbk1lbnUucHJvdG90eXBlLnJlbW92ZV9pdGVtID0gZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIG1lbnVfaXRlbTtcbiAgICBtZW51X2l0ZW0gPSB0aGlzLm1lbnVfaXRlbXNbaW5kZXhdO1xuICAgIC8vIHJlbW92ZSBtZW51IGl0ZW1cbiAgICB0aGlzLm1lbnVfaXRlbXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAvLyB1cGRhdGUgY3VycmVudF9pdGVtX2luZGV4IGlmIG5lY2Vzc2FyeVxuICAgIGlmICh0aGlzLmN1cnJlbnRfaXRlbV9pbmRleCA9PT0gaW5kZXgpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50X2l0ZW1faW5kZXggPSAwO1xuICAgIH1cbiAgICByZXR1cm4gbWVudV9pdGVtO1xufTtcblxuTWVudS5wcm90b3R5cGUuZW5hYmxlID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHRoaXMuY3VycmVudF9pdGVtX2luZGV4ID0gMDtcbiAgICBpZiAodGhpcy5tZW51X2l0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy5tZW51X2l0ZW1zW3RoaXMuY3VycmVudF9pdGVtX2luZGV4XS5zZWxlY3Rpb25fb3ZlcigpO1xuICAgIH1cbiAgICB0aGlzLmdhbWVfc3RhdGUuZ2FtZS5pbnB1dC5rZXlib2FyZC5hZGRDYWxsYmFja3ModGhpcywgdGhpcy5wcm9jZXNzX2lucHV0KTtcbn07XG5cbk1lbnUucHJvdG90eXBlLmRpc2FibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgaWYgKHRoaXMubWVudV9pdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMubWVudV9pdGVtc1t0aGlzLmN1cnJlbnRfaXRlbV9pbmRleF0uc2VsZWN0aW9uX291dCgpO1xuICAgIH1cbiAgICB0aGlzLmN1cnJlbnRfaXRlbV9pbmRleCA9IDA7XG59O1xuXG5NZW51LnByb3RvdHlwZS5zaG93ID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHRoaXMubWVudV9pdGVtcy5mb3JFYWNoKGZ1bmN0aW9uIChtZW51X2l0ZW0pIHtcbiAgICAgICAgbWVudV9pdGVtLnZpc2libGUgPSB0cnVlO1xuICAgIH0sIHRoaXMpO1xufTtcblxuTWVudS5wcm90b3R5cGUuaGlkZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB0aGlzLm1lbnVfaXRlbXMuZm9yRWFjaChmdW5jdGlvbiAobWVudV9pdGVtKSB7XG4gICAgICAgIG1lbnVfaXRlbS52aXNpYmxlID0gZmFsc2U7XG4gICAgfSwgdGhpcyk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IE1lbnU7XG4iLCJ2YXIgTWVudUl0ZW0gPSBmdW5jdGlvbiAoZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXF1aXJlKCcuLy4uL1RleHRQcmVmYWInKS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKTtcbn07XG5cbk1lbnVJdGVtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocmVxdWlyZSgnLi8uLi9UZXh0UHJlZmFiJykucHJvdG90eXBlKTtcbk1lbnVJdGVtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE1lbnVJdGVtO1xuXG5NZW51SXRlbS5wcm90b3R5cGUuc2VsZWN0aW9uX292ZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdGhpcy5maWxsID0gXCIjRkZGRjAwXCI7XG59O1xuXG5NZW51SXRlbS5wcm90b3R5cGUuc2VsZWN0aW9uX291dCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB0aGlzLmZpbGwgPSBcIiNGRkZGRkZcIjtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gTWVudUl0ZW07XG4iLCJ2YXIgUGxheWVyTWVudUl0ZW0gID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgcmVxdWlyZSgnLi9NZW51SXRlbScpLmNhbGwodGhpcywgZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpO1xuXG4gICAgdmFyIHNob3dTdGF0ID0gcmVxdWlyZSgnLi9TaG93U3RhdCcpO1xuICAgIHRoaXMucGxheWVyX3VuaXRfaGVhbHRoID0gbmV3IHNob3dTdGF0KHRoaXMuZ2FtZV9zdGF0ZSwgdGhpcy50ZXh0ICsgXCJfaGVhbHRoXCIsIHt4OiAyODAsIHk6IHRoaXMueX0sIHtncm91cDogXCJodWRcIiwgdGV4dDogXCJcIiwgc3R5bGU6IHByb3BlcnRpZXMuc3R5bGUsIHByZWZhYjogdGhpcy50ZXh0LCBzdGF0OiBcImhlYWx0aFwifSk7XG4gICAgdGhpcy5wbGF5ZXJfdW5pdF9tYW5hID0gbmV3IHNob3dTdGF0KHRoaXMuZ2FtZV9zdGF0ZSwgdGhpcy50ZXh0ICsgXCJfaGVhbHRoXCIsIHt4OiAyODAsIHk6IHRoaXMueX0sIHtncm91cDogXCJodWRcIiwgdGV4dDogXCJcIiwgc3R5bGU6IHByb3BlcnRpZXMuc3R5bGUsIHByZWZhYjogdGhpcy50ZXh0LCBzdGF0OiBcIm1hbmFcIn0pO1xufTtcblxuUGxheWVyTWVudUl0ZW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuL01lbnVJdGVtJykucHJvdG90eXBlKTtcblBsYXllck1lbnVJdGVtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBsYXllck1lbnVJdGVtO1xuXG5QbGF5ZXJNZW51SXRlbS5wcm90b3R5cGUuc2VsZWN0ID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBwbGF5ZXJfdW5pdCA9IHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzW3RoaXMudGV4dF07XG4gICAgLy8gdXNlIGN1cnJlbnQgc2VsZWN0ZWQgaXRlbSBvbiBzZWxlY3RlZCB1bml0XG4gICAgdGhpcy5nYW1lX3N0YXRlLnByZWZhYnMuaW52ZW50b3J5LnVzZV9pdGVtKHRoaXMuZ2FtZV9zdGF0ZS5jdXJyZW50X2l0ZW0sIHBsYXllcl91bml0KTtcblxuICAgIC8vIHNob3cgYWN0aW9ucyBtZW51IGFnYWluXG4gICAgdGhpcy5nYW1lX3N0YXRlLnByZWZhYnMuaXRlbXNfbWVudS5kaXNhYmxlKCk7XG4gICAgdGhpcy5nYW1lX3N0YXRlLnByZWZhYnMuaXRlbXNfbWVudS5oaWRlKCk7XG4gICAgdGhpcy5nYW1lX3N0YXRlLnByZWZhYnMuYWN0aW9uc19tZW51LnNob3coKTtcbiAgICB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5hY3Rpb25zX21lbnUuZW5hYmxlKCk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFBsYXllck1lbnVJdGVtO1xuIiwidmFyIFNob3dTdGF0ID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgcmVxdWlyZSgnLi8uLi9UZXh0UHJlZmFiJykuY2FsbCh0aGlzLCBnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcyk7XG4gICAgXG4gICAgdGhpcy5wcmVmYWIgPSB0aGlzLmdhbWVfc3RhdGUucHJlZmFic1twcm9wZXJ0aWVzLnByZWZhYl07XG4gICAgdGhpcy5zdGF0ID0gcHJvcGVydGllcy5zdGF0O1xufTtcblxuU2hvd1N0YXQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuLy4uL1RleHRQcmVmYWInKS5wcm90b3R5cGUpO1xuU2hvd1N0YXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU2hvd1N0YXQ7XG5cblNob3dTdGF0LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdGhpcy50ZXh0ID0gdGhpcy5wcmVmYWIuc3RhdHNbdGhpcy5zdGF0XTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gU2hvd1N0YXQ7XG4iLCJ2YXIgUHJlZmFiID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgUGhhc2VyLlNwcml0ZS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUuZ2FtZSwgcG9zaXRpb24ueCwgcG9zaXRpb24ueSwgcHJvcGVydGllcy50ZXh0dXJlKTtcblxuICAgIHRoaXMuZ2FtZV9zdGF0ZSA9IGdhbWVfc3RhdGU7XG5cbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuXG4gICAgdGhpcy5nYW1lX3N0YXRlLmdyb3Vwc1twcm9wZXJ0aWVzLmdyb3VwXS5hZGQodGhpcyk7XG4gICAgdGhpcy5mcmFtZSA9ICtwcm9wZXJ0aWVzLmZyYW1lO1xuXG4gICAgaWYgKHByb3BlcnRpZXMuc2NhbGUpIHtcbiAgICAgICAgdGhpcy5zY2FsZS5zZXRUbyhwcm9wZXJ0aWVzLnNjYWxlLngsIHByb3BlcnRpZXMuc2NhbGUueSk7XG4gICAgfVxuXG4gICAgdGhpcy5nYW1lX3N0YXRlLnByZWZhYnNbbmFtZV0gPSB0aGlzO1xufTtcblxuUHJlZmFiLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUpO1xuUHJlZmFiLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFByZWZhYjtcblxubW9kdWxlLmV4cG9ydHMgPSBQcmVmYWI7IiwidmFyIFRleHRQcmVmYWIgID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgUGhhc2VyLlRleHQuY2FsbCh0aGlzLCBnYW1lX3N0YXRlLmdhbWUsIHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIHByb3BlcnRpZXMudGV4dCwgcHJvcGVydGllcy5zdHlsZSk7XG4gICAgXG4gICAgdGhpcy5nYW1lX3N0YXRlID0gZ2FtZV9zdGF0ZTtcbiAgICBcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIFxuICAgIHRoaXMuZ2FtZV9zdGF0ZS5ncm91cHNbcHJvcGVydGllcy5ncm91cF0uYWRkKHRoaXMpO1xuICAgIFxuICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzW25hbWVdID0gdGhpcztcbn07XG5cblRleHRQcmVmYWIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuVGV4dC5wcm90b3R5cGUpO1xuVGV4dFByZWZhYi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBUZXh0UHJlZmFiO1xuXG5tb2R1bGUuZXhwb3J0cyA9IFRleHRQcmVmYWI7IiwidmFyIFRpbGVQcmVmYWIgPSBmdW5jdGlvbiAoZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBQaGFzZXIuVGlsZVNwcml0ZS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUuZ2FtZSwgcG9zaXRpb24ueCwgcG9zaXRpb24ueSwgcHJvcGVydGllcy53aWR0aCwgcHJvcGVydGllcy5oZWlnaHQsIHByb3BlcnRpZXMudGV4dHVyZSk7XG5cbiAgICB0aGlzLmdhbWVfc3RhdGUgPSBnYW1lX3N0YXRlO1xuXG4gICAgdGhpcy5uYW1lID0gbmFtZTtcblxuICAgIHRoaXMuZ2FtZV9zdGF0ZS5ncm91cHNbcHJvcGVydGllcy5ncm91cF0uYWRkKHRoaXMpO1xuICAgIHRoaXMuZnJhbWUgPSArcHJvcGVydGllcy5mcmFtZTtcblxuICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzW25hbWVdID0gdGhpcztcbn07XG5cblRpbGVQcmVmYWIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuVGlsZVNwcml0ZS5wcm90b3R5cGUpO1xuVGlsZVByZWZhYi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBUaWxlUHJlZmFiO1xuXG5tb2R1bGUuZXhwb3J0cyA9IFRpbGVQcmVmYWI7XG4iLCJ2YXIgQXR0YWNrID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgcmVxdWlyZSgnLi8uLi9QcmVmYWInKS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKTtcbiAgICBcbiAgICB0aGlzLm93bmVyID0gdGhpcy5nYW1lX3N0YXRlLnByZWZhYnNbcHJvcGVydGllcy5vd25lcl9uYW1lXTtcbn07XG5cbkF0dGFjay5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHJlcXVpcmUoJy4vLi4vUHJlZmFiJykucHJvdG90eXBlKTtcbkF0dGFjay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBdHRhY2s7XG5cbkF0dGFjay5wcm90b3R5cGUuc2hvd19tZXNzYWdlID0gZnVuY3Rpb24gKHRhcmdldCwgZGFtYWdlKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIGFjdGlvbl9tZXNzYWdlX3Bvc2l0aW9uLCBhY3Rpb25fbWVzc2FnZV90ZXh0LCBhdHRhY2tfbWVzc2FnZTtcbiAgICAvLyBzaG93IGF0dGFjayBtZXNzYWdlXG4gICAgYWN0aW9uX21lc3NhZ2VfcG9zaXRpb24gPSBuZXcgUGhhc2VyLlBvaW50KHRoaXMuZ2FtZV9zdGF0ZS5nYW1lLndvcmxkLndpZHRoIC8gMiwgdGhpcy5nYW1lX3N0YXRlLmdhbWUud29ybGQuaGVpZ2h0ICogMC4xKTtcbiAgICBhY3Rpb25fbWVzc2FnZV90ZXh0ID0gdGhpcy5vd25lci5uYW1lICsgXCIgYXR0YWNrcyBcIiArIHRhcmdldC5uYW1lICsgXCIgd2l0aCBcIiArIGRhbWFnZSArIFwiIGRhbWFnZVwiO1xuICAgIHZhciBhY3Rpb25NZXNzYWdlID0gcmVxdWlyZSgnLi8uLi9IVUQvQWN0aW9uTWVzc2FnZScpO1xuICAgIGF0dGFja19tZXNzYWdlID0gbmV3IGFjdGlvbk1lc3NhZ2UodGhpcy5nYW1lX3N0YXRlLCB0aGlzLm5hbWUgKyBcIl9hY3Rpb25fbWVzc2FnZVwiLCBhY3Rpb25fbWVzc2FnZV9wb3NpdGlvbiwge2dyb3VwOiBcImh1ZFwiLCB0ZXh0dXJlOiAgICAgXCJyZWN0YW5nbGVfaW1hZ2VcIiwgc2NhbGU6IHt4OiAwLjg1LCB5OiAwLjJ9LCBkdXJhdGlvbjogMSwgbWVzc2FnZTogYWN0aW9uX21lc3NhZ2VfdGV4dH0pO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBBdHRhY2s7IiwidmFyIEVuZW15VW5pdCA9IGZ1bmN0aW9uIChnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHJlcXVpcmUoJy4vVW5pdCcpLmNhbGwodGhpcywgZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpO1xuXG4gICAgdGhpcy5hbmNob3Iuc2V0VG8oMC41KTtcblxuICAgIHRoaXMuc2NhbGUuc2V0VG8oLTEsIDEpO1xufTtcblxuRW5lbXlVbml0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocmVxdWlyZSgnLi9Vbml0JykucHJvdG90eXBlKTtcbkVuZW15VW5pdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBFbmVteVVuaXQ7XG5cbkVuZW15VW5pdC5wcm90b3R5cGUuYWN0ID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciB0YXJnZXRfaW5kZXgsIHRhcmdldCwgZGFtYWdlO1xuICAgIC8vIHJhbmRvbWx5IGNob29zZSB0YXJnZXRcbiAgICB0YXJnZXRfaW5kZXggPSB0aGlzLmdhbWVfc3RhdGUucm5kLmJldHdlZW4oMCwgdGhpcy5nYW1lX3N0YXRlLmdyb3Vwcy5wbGF5ZXJfdW5pdHMuY291bnRMaXZpbmcoKSAtIDEpO1xuICAgIHRhcmdldCA9IHRoaXMuZ2FtZV9zdGF0ZS5ncm91cHMucGxheWVyX3VuaXRzLmNoaWxkcmVuW3RhcmdldF9pbmRleF07XG5cbiAgICB0aGlzLmF0dGFjayh0YXJnZXQpO1xufTtcblxuRW5lbXlVbml0LnByb3RvdHlwZS5raWxsID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBtZW51X2l0ZW1faW5kZXgsIG1lbnVfaXRlbTtcbiAgICBQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5raWxsLmNhbGwodGhpcyk7XG4gICAgLy8gcmVtb3ZlIGZyb20gdGhlIG1lbnVcbiAgICBtZW51X2l0ZW1faW5kZXggPSB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5lbmVteV91bml0c19tZW51LmZpbmRfaXRlbV9pbmRleCh0aGlzLm5hbWUpO1xuICAgIG1lbnVfaXRlbSA9IHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLmVuZW15X3VuaXRzX21lbnUucmVtb3ZlX2l0ZW0obWVudV9pdGVtX2luZGV4KTtcbiAgICBtZW51X2l0ZW0ua2lsbCgpO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBFbmVteVVuaXQ7IiwidmFyIE1hZ2ljQXR0YWNrID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgcmVxdWlyZSgnLi9BdHRhY2snKS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKTtcbiAgICBcbiAgICB0aGlzLm1hbmFfY29zdCA9IHByb3BlcnRpZXMubWFuYV9jb3N0O1xufTtcblxuTWFnaWNBdHRhY2sucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuL0F0dGFjaycpLnByb3RvdHlwZSk7XG5NYWdpY0F0dGFjay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBNYWdpY0F0dGFjaztcblxuTWFnaWNBdHRhY2sucHJvdG90eXBlLmhpdCA9IGZ1bmN0aW9uICh0YXJnZXQpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgZGFtYWdlLCBhdHRhY2tfbXVsdGlwbGllciwgZGVmZW5zZV9tdWx0aXBsaWVyLCBhY3Rpb25fbWVzc2FnZV9wb3NpdGlvbiwgYWN0aW9uX21lc3NhZ2VfdGV4dCwgYXR0YWNrX21lc3NhZ2U7XG4gICAgLy8gdGhlIGF0dGFjayBtdWx0aXBsaWVyIGZvciBtYWdpYyBhdHRhY2tzIGlzIGhpZ2hlclxuICAgIGF0dGFja19tdWx0aXBsaWVyID0gdGhpcy5nYW1lX3N0YXRlLmdhbWUucm5kLnJlYWxJblJhbmdlKDAuOSwgMS4zKTtcbiAgICBkZWZlbnNlX211bHRpcGxpZXIgPSB0aGlzLmdhbWVfc3RhdGUuZ2FtZS5ybmQucmVhbEluUmFuZ2UoMC44LCAxLjIpO1xuICAgIC8vIGNhbGN1bGF0ZSBkYW1hZ2UgdXNpbmcgdGhlIG1hZ2ljIGF0dGFjayBzdGF0XG4gICAgZGFtYWdlID0gTWF0aC5tYXgoMCwgTWF0aC5yb3VuZCgoYXR0YWNrX211bHRpcGxpZXIgKiB0aGlzLm93bmVyLnN0YXRzLm1hZ2ljX2F0dGFjaykgLSAoZGVmZW5zZV9tdWx0aXBsaWVyICogdGFyZ2V0LnN0YXRzLmRlZmVuc2UpKSk7XG4gICAgLy8gYXBwbHkgZGFtYWdlXG4gICAgdGFyZ2V0LnJlY2VpdmVfZGFtYWdlKGRhbWFnZSk7XG4gICAgXG4gICAgLy8gcmVkdWNlIHRoZSB1bml0IG1hbmFcbiAgICB0aGlzLmdhbWVfc3RhdGUuY3VycmVudF91bml0LnN0YXRzLm1hbmEgLT0gdGhpcy5tYW5hX2Nvc3Q7XG4gICAgXG4gICAgdGhpcy5zaG93X21lc3NhZ2UodGFyZ2V0LCBkYW1hZ2UpO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBNYWdpY0F0dGFjazsiLCJ2YXIgUGh5c2ljYWxBdHRhY2sgPSBmdW5jdGlvbiAoZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXF1aXJlKCcuL0F0dGFjaycpLmNhbGwodGhpcywgZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpO1xufTtcblxuUGh5c2ljYWxBdHRhY2sucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuL0F0dGFjaycpLnByb3RvdHlwZSk7XG5QaHlzaWNhbEF0dGFjay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaHlzaWNhbEF0dGFjaztcblxuUGh5c2ljYWxBdHRhY2sucHJvdG90eXBlLmhpdCA9IGZ1bmN0aW9uICh0YXJnZXQpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgZGFtYWdlLCBhdHRhY2tfbXVsdGlwbGllciwgZGVmZW5zZV9tdWx0aXBsaWVyLCBhY3Rpb25fbWVzc2FnZV9wb3NpdGlvbiwgYWN0aW9uX21lc3NhZ2VfdGV4dCwgYXR0YWNrX21lc3NhZ2U7XG4gICAgLy8gY2FsY3VsYXRlIHJhbmRvbSBhdHRhY2sgYW5kIGRlZmVuc2UgbXVsdGlwbGllcnNcbiAgICBhdHRhY2tfbXVsdGlwbGllciA9IHRoaXMuZ2FtZV9zdGF0ZS5nYW1lLnJuZC5yZWFsSW5SYW5nZSgwLjgsIDEuMik7XG4gICAgZGVmZW5zZV9tdWx0aXBsaWVyID0gdGhpcy5nYW1lX3N0YXRlLmdhbWUucm5kLnJlYWxJblJhbmdlKDAuOCwgMS4yKTtcbiAgICAvLyBjYWxjdWxhdGUgZGFtYWdlXG4gICAgZGFtYWdlID0gTWF0aC5tYXgoMCwgTWF0aC5yb3VuZCgoYXR0YWNrX211bHRpcGxpZXIgKiB0aGlzLm93bmVyLnN0YXRzLmF0dGFjaykgLSAoZGVmZW5zZV9tdWx0aXBsaWVyICogdGFyZ2V0LnN0YXRzLmRlZmVuc2UpKSk7XG4gICAgLy8gYXBwbHkgZGFtYWdlXG4gICAgdGFyZ2V0LnJlY2VpdmVfZGFtYWdlKGRhbWFnZSk7XG4gICAgXG4gICAgdGhpcy5zaG93X21lc3NhZ2UodGFyZ2V0LCBkYW1hZ2UpO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBQaHlzaWNhbEF0dGFjazsiLCJ2YXIgUGxheWVyVW5pdCA9IGZ1bmN0aW9uIChnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHJlcXVpcmUoJy4vVW5pdCcpLmNhbGwodGhpcywgZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpO1xuXG4gICAgdGhpcy5hbmNob3Iuc2V0VG8oMC41KTtcbn07XG5cblBsYXllclVuaXQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuL1VuaXQnKS5wcm90b3R5cGUpO1xuUGxheWVyVW5pdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQbGF5ZXJVbml0O1xuXG5QbGF5ZXJVbml0LnByb3RvdHlwZS5hY3QgPSBmdW5jdGlvbiAoKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIHVuaXRfaW5kZXgsIHBsYXllcl91bml0c19tZW51X2l0ZW1zO1xuICAgIC8vIHNlYXJjaCBmb3IgdGhlIGluZGV4IG9mIHRoaXMgdW5pdCBpbiB0aGUgcGxheWVyX3VuaXRzX21lbnVcbiAgICB1bml0X2luZGV4ID0gdGhpcy5nYW1lX3N0YXRlLnByZWZhYnMucGxheWVyX3VuaXRzX21lbnUuZmluZF9pdGVtX2luZGV4KHRoaXMubmFtZSk7XG4gICAgdGhpcy5nYW1lX3N0YXRlLnByZWZhYnMucGxheWVyX3VuaXRzX21lbnUubW92ZV9zZWxlY3Rpb24odW5pdF9pbmRleCk7XG5cbiAgICAvLyBlbmFibGUgbWVudSBmb3IgY2hvb3NpbmcgdGhlIGFjdGlvblxuICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLmFjdGlvbnNfbWVudS5lbmFibGUoKTtcbn07XG5cblBsYXllclVuaXQucHJvdG90eXBlLmtpbGwgPSBmdW5jdGlvbiAoKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIG1lbnVfaXRlbV9pbmRleCwgbWVudV9pdGVtO1xuICAgIFBoYXNlci5TcHJpdGUucHJvdG90eXBlLmtpbGwuY2FsbCh0aGlzKTtcbiAgICAvLyByZW1vdmUgZnJvbSB0aGUgbWVudVxuICAgIG1lbnVfaXRlbV9pbmRleCA9IHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLnBsYXllcl91bml0c19tZW51LmZpbmRfaXRlbV9pbmRleCh0aGlzLm5hbWUpO1xuICAgIHRoaXMuZ2FtZV9zdGF0ZS5wcmVmYWJzLnBsYXllcl91bml0c19tZW51Lm1lbnVfaXRlbXNbbWVudV9pdGVtX2luZGV4XS5hbHBoYSA9IDAuNTtcbn07XG5cblBsYXllclVuaXQucHJvdG90eXBlLnJlY2VpdmVfZXhwZXJpZW5jZSA9IGZ1bmN0aW9uIChleHBlcmllbmNlKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgLy8gaW5jcmVhc2UgZXhwZXJpZW5jZVxuICAgIHRoaXMuc3RhdHMuZXhwZXJpZW5jZSArPSBleHBlcmllbmNlO1xuICAgIHZhciBuZXh0X2xldmVsX2RhdGEgPSB0aGlzLmdhbWVfc3RhdGUuZXhwZXJpZW5jZV90YWJsZVt0aGlzLnN0YXRzLmN1cnJlbnRfbGV2ZWxdO1xuICAgIC8vIGlmIGN1cnJlbnQgZXhwZXJpZW5jZSBpcyBncmVhdGVyIHRoYW4gdGhlIG5lY2Vzc2FyeSB0byB0aGUgbmV4dCBsZXZlbCwgdGhlIHVuaXQgZ2FpbnMgYSBsZXZlbFxuICAgIGlmICh0aGlzLnN0YXRzLmV4cGVyaWVuY2UgPj0gbmV4dF9sZXZlbF9kYXRhLnJlcXVpcmVkX2V4cCkge1xuICAgICAgICB0aGlzLnN0YXRzLmN1cnJlbnRfbGV2ZWwgKz0gMTtcbiAgICAgICAgdGhpcy5zdGF0cy5leHBlcmllbmNlID0gMDtcbiAgICAgICAgLy8gaW5jcmVhc2UgdW5pdCBzdGF0cyBhY2NvcmRpbmcgdG8gbmV3IGxldmVsXG4gICAgICAgIGZvciAodmFyIHN0YXQgaW4gbmV4dF9sZXZlbF9kYXRhLnN0YXRzX2luY3JlYXNlKSB7XG4gICAgICAgICAgICBpZiAobmV4dF9sZXZlbF9kYXRhLnN0YXRzX2luY3JlYXNlLmhhc093blByb3BlcnR5KHN0YXQpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0c1tzdGF0XSArPSBuZXh0X2xldmVsX2RhdGEuc3RhdHNfaW5jcmVhc2Vbc3RhdF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFBsYXllclVuaXQ7IiwidmFyIFVuaXQgPSBmdW5jdGlvbiAoZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXF1aXJlKCcuLy4uL1ByZWZhYicpLmNhbGwodGhpcywgZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpO1xuXG4gICAgdGhpcy5hbmNob3Iuc2V0VG8oMC41KTtcblxuICAgIHRoaXMuc3RhdHMgPSBwcm9wZXJ0aWVzLnN0YXRzO1xuXG4gICAgdGhpcy5hdHRhY2tlZF9hbmltYXRpb24gPSB0aGlzLmdhbWVfc3RhdGUuZ2FtZS5hZGQudHdlZW4odGhpcyk7XG4gICAgdGhpcy5hdHRhY2tlZF9hbmltYXRpb24udG8oe3RpbnQ6IDB4RkYwMDAwfSwgMjAwKTtcbiAgICB0aGlzLmF0dGFja2VkX2FuaW1hdGlvbi5vbkNvbXBsZXRlLmFkZCh0aGlzLnJlc3RvcmVfdGludCwgdGhpcyk7XG59O1xuXG5Vbml0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocmVxdWlyZSgnLi8uLi9QcmVmYWInKS5wcm90b3R5cGUpO1xuVW5pdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVbml0O1xuXG5Vbml0LnByb3RvdHlwZS5jYWxjdWxhdGVfYWN0X3R1cm4gPSBmdW5jdGlvbiAoY3VycmVudF90dXJuKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgLy8gY2FsY3VsYXRlIHRoZSBhY3QgdHVybiBiYXNlZCBvbiB0aGUgdW5pdCBzcGVlZFxuICAgIHRoaXMuYWN0X3R1cm4gPSBjdXJyZW50X3R1cm4gKyBNYXRoLmNlaWwoMTAwIC8gdGhpcy5zdGF0cy5zcGVlZCk7XG59O1xuXG5Vbml0LnByb3RvdHlwZS5yZWNlaXZlX2RhbWFnZSA9IGZ1bmN0aW9uIChkYW1hZ2UpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB0aGlzLnN0YXRzLmhlYWx0aCAtPSBkYW1hZ2U7XG4gICAgdGhpcy5hdHRhY2tlZF9hbmltYXRpb24uc3RhcnQoKTtcbiAgICBpZiAodGhpcy5zdGF0cy5oZWFsdGggPD0gMCkge1xuICAgICAgICB0aGlzLnN0YXRzLmhlYWx0aCA9IDA7XG4gICAgICAgIHRoaXMua2lsbCgpO1xuICAgIH1cbn07XG5cblVuaXQucHJvdG90eXBlLnJlc3RvcmVfdGludCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB0aGlzLnRpbnQgPSAweEZGRkZGRjtcbn07XG5cblVuaXQucHJvdG90eXBlLmF0dGFjayA9IGZ1bmN0aW9uICh0YXJnZXQpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgZGFtYWdlLCBhdHRhY2tfbXVsdGlwbGllciwgZGVmZW5zZV9tdWx0aXBsaWVyLCBhY3Rpb25fbWVzc2FnZV9wb3NpdGlvbiwgYWN0aW9uX21lc3NhZ2VfdGV4dCwgYXR0YWNrX21lc3NhZ2U7XG4gICAgLy8gYXR0YWNrIHRhcmdldFxuICAgIGF0dGFja19tdWx0aXBsaWVyID0gdGhpcy5nYW1lX3N0YXRlLmdhbWUucm5kLnJlYWxJblJhbmdlKDAuOCwgMS4yKTtcbiAgICBkZWZlbnNlX211bHRpcGxpZXIgPSB0aGlzLmdhbWVfc3RhdGUuZ2FtZS5ybmQucmVhbEluUmFuZ2UoMC44LCAxLjIpO1xuICAgIGRhbWFnZSA9IE1hdGgucm91bmQoKGF0dGFja19tdWx0aXBsaWVyICogdGhpcy5zdGF0cy5hdHRhY2spIC0gKGRlZmVuc2VfbXVsdGlwbGllciAqIHRhcmdldC5zdGF0cy5kZWZlbnNlKSk7XG4gICAgdGFyZ2V0LnJlY2VpdmVfZGFtYWdlKGRhbWFnZSk7XG5cbiAgICAvLyBzaG93IGF0dGFjayBtZXNzYWdlXG4gICAgYWN0aW9uX21lc3NhZ2VfcG9zaXRpb24gPSBuZXcgUGhhc2VyLlBvaW50KHRoaXMuZ2FtZV9zdGF0ZS5nYW1lLndvcmxkLndpZHRoIC8gMiwgdGhpcy5nYW1lX3N0YXRlLmdhbWUud29ybGQuaGVpZ2h0ICogMC4xKTtcbiAgICBhY3Rpb25fbWVzc2FnZV90ZXh0ID0gdGhpcy5uYW1lICsgXCIgYXR0YWNrcyBcIiArIHRhcmdldC5uYW1lICsgXCIgd2l0aCBcIiArIGRhbWFnZSArIFwiIGRhbWFnZVwiO1xuICAgIHZhciBhY3Rpb25NZXNzYWdlID0gcmVxdWlyZSgnLi8uLi9IVUQvQWN0aW9uTWVzc2FnZScpO1xuICAgIGF0dGFja19tZXNzYWdlID0gbmV3IGFjdGlvbk1lc3NhZ2UodGhpcy5nYW1lX3N0YXRlLCB0aGlzLm5hbWUgKyBcIl9hY3Rpb25fbWVzc2FnZVwiLCBhY3Rpb25fbWVzc2FnZV9wb3NpdGlvbiwge1xuICAgICAgICBncm91cDogXCJodWRcIixcbiAgICAgICAgdGV4dHVyZTogXCJyZWN0YW5nbGVfaW1hZ2VcIixcbiAgICAgICAgc2NhbGU6IHt4OiAwLjc1LCB5OiAwLjJ9LFxuICAgICAgICBkdXJhdGlvbjogMSxcbiAgICAgICAgbWVzc2FnZTogYWN0aW9uX21lc3NhZ2VfdGV4dFxuICAgIH0pO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBVbml0OyIsInZhciBJbnZlbnRvcnkgPSBmdW5jdGlvbiAoZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXF1aXJlKCcuLy4uL1ByZWZhYicpLmNhbGwodGhpcywgZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpO1xuICAgIFxuICAgIHRoaXMuaXRlbV9jbGFzc2VzID0ge1xuICAgICAgICBcInBvdGlvblwiOiByZXF1aXJlKCcuL1BvdGlvbicpLnByb3RvdHlwZS5jb25zdHJ1Y3RvclxuICAgIH07XG5cbiAgICB0aGlzLml0ZW1zID0gW107XG59O1xuXG5JbnZlbnRvcnkucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuLy4uL1ByZWZhYicpLnByb3RvdHlwZSk7XG5JbnZlbnRvcnkucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSW52ZW50b3J5O1xuXG5JbnZlbnRvcnkucHJvdG90eXBlLmNyZWF0ZV9tZW51ID0gZnVuY3Rpb24gKHBvc2l0aW9uKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIG1lbnVfaXRlbXMsIGl0ZW1faW5kZXgsIGl0ZW0sIG1lbnVfaXRlbSwgaXRlbXNfbWVudTtcbiAgICAvLyBjcmVhdGUgdW5pdHMgbWVudSBpdGVtc1xuICAgIGl0ZW1faW5kZXggPSAwO1xuICAgIG1lbnVfaXRlbXMgPSBbXTtcbiAgICBmb3IgKGl0ZW1faW5kZXggPSAwOyBpdGVtX2luZGV4IDwgdGhpcy5pdGVtcy5sZW5ndGg7IGl0ZW1faW5kZXggKz0gMSkge1xuICAgICAgICBpdGVtID0gdGhpcy5pdGVtc1tpdGVtX2luZGV4XTtcbiAgICAgICAgdmFyIGl0ZW1NZW51SXRlbSA9IHJlcXVpcmUoJy4vLi4vSFVEL0l0ZW1NZW51SXRlbScpO1xuICAgICAgICBtZW51X2l0ZW0gPSBuZXcgaXRlbU1lbnVJdGVtKHRoaXMuZ2FtZV9zdGF0ZSwgaXRlbS5uYW1lICsgXCJfbWVudV9pdGVtXCIsIHt4OiBwb3NpdGlvbi54LCB5OiBwb3NpdGlvbi55ICsgaXRlbV9pbmRleCAqIDIwfSwge2dyb3VwOiBcImh1ZFwiLCB0ZXh0OiBpdGVtLm5hbWUsIHN0eWxlOiBPYmplY3QuY3JlYXRlKHRoaXMuZ2FtZV9zdGF0ZS5URVhUX1NUWUxFKX0pO1xuICAgICAgICBtZW51X2l0ZW1zLnB1c2gobWVudV9pdGVtKTtcbiAgICB9XG4gICAgLy8gY3JlYXRlIHVuaXRzIG1lbnVcbiAgICB2YXIgbWVudSA9IHJlcXVpcmUoJy4vLi4vSFVEL01lbnUnKTtcbiAgICBpdGVtc19tZW51ID0gbmV3IG1lbnUodGhpcy5nYW1lX3N0YXRlLCBcIml0ZW1zX21lbnVcIiwgcG9zaXRpb24sIHtncm91cDogXCJodWRcIiwgbWVudV9pdGVtczogbWVudV9pdGVtc30pO1xuICAgIGl0ZW1zX21lbnUuaGlkZSgpO1xufTtcblxuSW52ZW50b3J5LnByb3RvdHlwZS5jb2xsZWN0X2l0ZW0gPSBmdW5jdGlvbiAoaXRlbV9vYmplY3QpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgaXRlbSA9IG5ldyB0aGlzLml0ZW1fY2xhc3Nlc1tpdGVtX29iamVjdC50eXBlXSh0aGlzLmdhbWVfc3RhdGUsIGl0ZW1fb2JqZWN0LnR5cGUgKyB0aGlzLml0ZW1zLmxlbmd0aCwge3g6IDAsIHk6IDB9LCBpdGVtX29iamVjdC5wcm9wZXJ0aWVzKTtcbiAgICB0aGlzLml0ZW1zLnB1c2goaXRlbSk7XG59O1xuXG5JbnZlbnRvcnkucHJvdG90eXBlLnVzZV9pdGVtID0gZnVuY3Rpb24gKGl0ZW1fbmFtZSwgdGFyZ2V0KSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgLy8gcmVtb3ZlIGl0ZW0gZnJvbSBpdGVtcyBsaXN0XG4gICAgZm9yICh2YXIgaXRlbV9pbmRleCA9IDA7IGl0ZW1faW5kZXggPCB0aGlzLml0ZW1zLmxlbmd0aDsgaXRlbV9pbmRleCArPSAxKSB7XG4gICAgICAgIGlmICh0aGlzLml0ZW1zW2l0ZW1faW5kZXhdLm5hbWUgPT09IGl0ZW1fbmFtZSkge1xuICAgICAgICAgICAgdGhpcy5pdGVtc1tpdGVtX2luZGV4XS51c2UodGFyZ2V0KTtcbiAgICAgICAgICAgIHRoaXMuaXRlbXMuc3BsaWNlKGl0ZW1faW5kZXgsIDEpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IEludmVudG9yeTtcbiIsInZhciBJdGVtID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgcmVxdWlyZSgnLi8uLi9QcmVmYWInKS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKTtcbn07XG5cbkl0ZW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShyZXF1aXJlKCcuLy4uL1ByZWZhYicpLnByb3RvdHlwZSk7XG5JdGVtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEl0ZW07XG5cbkl0ZW0ucHJvdG90eXBlLnVzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICAvLyBieSBkZWZhdWx0IHRoZSBpdGVtIGlzIGRlc3Ryb3llZFxuICAgIHRoaXMua2lsbCgpO1xufTtcblxuSXRlbS5wcm90b3R5cGUua2lsbCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5raWxsLmNhbGwodGhpcyk7XG4gICAgLy8gcmVtb3ZlIGl0ZW0gZnJvbSB0aGUgbWVudVxuICAgIHZhciBtZW51X2l0ZW1faW5kZXggPSB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5pdGVtc19tZW51LmZpbmRfaXRlbV9pbmRleCh0aGlzLm5hbWUpO1xuICAgIHZhciBtZW51X2l0ZW0gPSB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5pdGVtc19tZW51LnJlbW92ZV9pdGVtKG1lbnVfaXRlbV9pbmRleCk7XG4gICAgbWVudV9pdGVtLmtpbGwoKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gSXRlbTsiLCJ2YXIgUG90aW9uID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgcmVxdWlyZSgnLi9JdGVtJykuY2FsbCh0aGlzLCBnYW1lX3N0YXRlLCBuYW1lLCBwb3NpdGlvbiwgcHJvcGVydGllcyk7XG4gICAgdGhpcy5oZWFsdGhfcG93ZXIgPSBwcm9wZXJ0aWVzLmhlYWx0aF9wb3dlcjtcbn07XG5cblBvdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHJlcXVpcmUoJy4vSXRlbScpLnByb3RvdHlwZSk7XG5Qb3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUG90aW9uO1xuXG5Qb3Rpb24ucHJvdG90eXBlLnVzZSA9IGZ1bmN0aW9uICh0YXJnZXQpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXF1aXJlKCcuL0l0ZW0nKS5wcm90b3R5cGUudXNlLmNhbGwodGhpcyk7XG4gICAgdGFyZ2V0LnN0YXRzLmhlYWx0aCArPSB0aGlzLmhlYWx0aF9wb3dlcjtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUG90aW9uOyIsInZhciBFbmVteVNwYXduZXIgPSBmdW5jdGlvbiAoZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXF1aXJlKCcuLy4uL1ByZWZhYicpLmNhbGwodGhpcywgZ2FtZV9zdGF0ZSwgbmFtZSwgcG9zaXRpb24sIHByb3BlcnRpZXMpO1xuICAgIFxuICAgIHRoaXMuZ2FtZV9zdGF0ZS5nYW1lLnBoeXNpY3MuYXJjYWRlLmVuYWJsZSh0aGlzKTtcbiAgICB0aGlzLmJvZHkuaW1tb3ZhYmxlID0gdHJ1ZTtcbiAgICBcbiAgICB0aGlzLm92ZXJsYXBwaW5nID0gdHJ1ZTtcbn07XG5cbkVuZW15U3Bhd25lci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHJlcXVpcmUoJy4vLi4vUHJlZmFiJykucHJvdG90eXBlKTtcbkVuZW15U3Bhd25lci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBFbmVteVNwYXduZXI7XG5cbkVuZW15U3Bhd25lci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHRoaXMub3ZlcmxhcHBpbmcgPSB0aGlzLmdhbWVfc3RhdGUuZ2FtZS5waHlzaWNzLmFyY2FkZS5vdmVybGFwKHRoaXMsIHRoaXMuZ2FtZV9zdGF0ZS5ncm91cHMucGxheWVycywgdGhpcy5jaGVja19mb3Jfc3Bhd24sIG51bGwsIHRoaXMpO1xufTtcblxuRW5lbXlTcGF3bmVyLnByb3RvdHlwZS5jaGVja19mb3Jfc3Bhd24gPSBmdW5jdGlvbiAoKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIHNwYXduX2NoYW5jZSwgZW5jb3VudGVyX2luZGV4LCBlbmVteV9lbmNvdW50ZXI7XG4gICAgLy8gY2hlY2sgZm9yIHNwYXduIG9ubHkgb25jZSBmb3Igb3ZlcmxhcFxuICAgIGlmICghdGhpcy5vdmVybGFwcGluZykge1xuICAgICAgICBzcGF3bl9jaGFuY2UgPSB0aGlzLmdhbWVfc3RhdGUuZ2FtZS5ybmQuZnJhYygpO1xuICAgICAgICAvLyBjaGVjayBpZiB0aGUgZW5lbXkgc3Bhd24gcHJvYmFiaWxpdHkgaXMgbGVzcyB0aGFuIHRoZSBnZW5lcmF0ZWQgcmFuZG9tIG51bWJlciBmb3IgZWFjaCBzcGF3blxuICAgICAgICBmb3IgKGVuY291bnRlcl9pbmRleCA9IDA7IGVuY291bnRlcl9pbmRleCA8IHRoaXMuZ2FtZV9zdGF0ZS5sZXZlbF9kYXRhLmVuZW15X2VuY291bnRlcnMubGVuZ3RoOyBlbmNvdW50ZXJfaW5kZXggKz0gMSkge1xuICAgICAgICAgICAgZW5lbXlfZW5jb3VudGVyID0gdGhpcy5nYW1lX3N0YXRlLmxldmVsX2RhdGEuZW5lbXlfZW5jb3VudGVyc1tlbmNvdW50ZXJfaW5kZXhdO1xuICAgICAgICAgICAgaWYgKHNwYXduX2NoYW5jZSA8PSBlbmVteV9lbmNvdW50ZXIucHJvYmFiaWxpdHkpIHtcbiAgICAgICAgICAgICAgICAvLyBzYXZlIGN1cnJlbnQgcGxheWVyIHBvc2l0aW9uIGZvciBsYXRlclxuICAgICAgICAgICAgICAgIHRoaXMuZ2FtZV9zdGF0ZS5wbGF5ZXJfcG9zaXRpb24gPSB0aGlzLmdhbWVfc3RhdGUucHJlZmFicy5wbGF5ZXIucG9zaXRpb247XG4gICAgICAgICAgICAgICAgLy8gY2FsbCBiYXR0bGUgc3RhdGVcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRPIEJBVFRMRVwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLmdhbWVfc3RhdGUuZ2FtZS5zdGF0ZS5zdGFydChcIkJvb3RTdGF0ZVwiLCBmYWxzZSwgZmFsc2UsIFwiYXNzZXRzL2xldmVscy9iYXR0bGUuanNvblwiLCBcIkJhdHRsZVN0YXRlXCIsIHtlbmNvdW50ZXI6IGVuZW15X2VuY291bnRlciwgcGFydHlfZGF0YTogdGhpcy5nYW1lX3N0YXRlLnBhcnR5X2RhdGEsIGludmVudG9yeTogdGhpcy5nYW1lX3N0YXRlLmludmVudG9yeX0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBFbmVteVNwYXduZXI7XG4iLCJ2YXIgUGxheWVyID0gZnVuY3Rpb24gKGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgcmVxdWlyZSgnLi8uLi9QcmVmYWInKS5jYWxsKHRoaXMsIGdhbWVfc3RhdGUsIG5hbWUsIHBvc2l0aW9uLCBwcm9wZXJ0aWVzKTtcbiAgICBcbiAgICB0aGlzLmFuY2hvci5zZXRUbygwLjUpO1xuICAgIFxuICAgIHRoaXMud2Fsa2luZ19zcGVlZCA9ICtwcm9wZXJ0aWVzLndhbGtpbmdfc3BlZWQ7XG4gICAgXG4gICAgdGhpcy5hbmltYXRpb25zLmFkZChcIndhbGtpbmdfZG93blwiLCBbNiwgNywgOF0sIDEwLCB0cnVlKTtcbiAgICB0aGlzLmFuaW1hdGlvbnMuYWRkKFwid2Fsa2luZ19sZWZ0XCIsIFs5LCAxMCwgMTFdLCAxMCwgdHJ1ZSk7XG4gICAgdGhpcy5hbmltYXRpb25zLmFkZChcIndhbGtpbmdfcmlnaHRcIiwgWzMsIDQsIDVdLCAxMCwgdHJ1ZSk7XG4gICAgdGhpcy5hbmltYXRpb25zLmFkZChcIndhbGtpbmdfdXBcIiwgWzAsIDEsIDJdLCAxMCwgdHJ1ZSk7XG4gICAgXG4gICAgdGhpcy5zdG9wcGVkX2ZyYW1lcyA9IFs3LCAxMCwgNCwgMSwgN107XG5cbiAgICB0aGlzLmdhbWVfc3RhdGUuZ2FtZS5waHlzaWNzLmFyY2FkZS5lbmFibGUodGhpcyk7XG4gICAgdGhpcy5ib2R5LnNldFNpemUoMTYsIDE2LCAwLCA4KTtcbiAgICB0aGlzLmJvZHkuY29sbGlkZVdvcmxkQm91bmRzID0gdHJ1ZTtcblxuICAgIHRoaXMuY3Vyc29ycyA9IHRoaXMuZ2FtZV9zdGF0ZS5nYW1lLmlucHV0LmtleWJvYXJkLmNyZWF0ZUN1cnNvcktleXMoKTtcbn07XG5cblBsYXllci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHJlcXVpcmUoJy4vLi4vUHJlZmFiJykucHJvdG90eXBlKTtcblBsYXllci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQbGF5ZXI7XG5cblBsYXllci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHRoaXMuZ2FtZV9zdGF0ZS5nYW1lLnBoeXNpY3MuYXJjYWRlLmNvbGxpZGUodGhpcywgdGhpcy5nYW1lX3N0YXRlLmxheWVycy5jb2xsaXNpb25fYmFjayk7XG4gICAgdGhpcy5nYW1lX3N0YXRlLmdhbWUucGh5c2ljcy5hcmNhZGUuY29sbGlkZSh0aGlzLCB0aGlzLmdhbWVfc3RhdGUubGF5ZXJzLmNvbGxpc2lvbl9mcm9udCk7XG4gICAgXG4gICAgaWYgKHRoaXMuY3Vyc29ycy5sZWZ0LmlzRG93biAmJiB0aGlzLmJvZHkudmVsb2NpdHkueCA8PSAwKSB7XG4gICAgICAgIC8vIG1vdmUgbGVmdFxuICAgICAgICB0aGlzLmJvZHkudmVsb2NpdHkueCA9IC10aGlzLndhbGtpbmdfc3BlZWQ7XG4gICAgICAgIGlmICh0aGlzLmJvZHkudmVsb2NpdHkueSA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5hbmltYXRpb25zLnBsYXkoXCJ3YWxraW5nX2xlZnRcIik7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRoaXMuY3Vyc29ycy5yaWdodC5pc0Rvd24gJiYgdGhpcy5ib2R5LnZlbG9jaXR5LnggPj0gMCkge1xuICAgICAgICAvLyBtb3ZlIHJpZ2h0XG4gICAgICAgIHRoaXMuYm9keS52ZWxvY2l0eS54ID0gK3RoaXMud2Fsa2luZ19zcGVlZDtcbiAgICAgICAgaWYgKHRoaXMuYm9keS52ZWxvY2l0eS55ID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmFuaW1hdGlvbnMucGxheShcIndhbGtpbmdfcmlnaHRcIik7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmJvZHkudmVsb2NpdHkueCA9IDA7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY3Vyc29ycy51cC5pc0Rvd24gJiYgdGhpcy5ib2R5LnZlbG9jaXR5LnkgPD0gMCkge1xuICAgICAgICAvLyBtb3ZlIHVwXG4gICAgICAgIHRoaXMuYm9keS52ZWxvY2l0eS55ID0gLXRoaXMud2Fsa2luZ19zcGVlZDtcbiAgICAgICAgaWYgKHRoaXMuYm9keS52ZWxvY2l0eS54ID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmFuaW1hdGlvbnMucGxheShcIndhbGtpbmdfdXBcIik7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRoaXMuY3Vyc29ycy5kb3duLmlzRG93biAmJiB0aGlzLmJvZHkudmVsb2NpdHkueSA+PSAwKSB7XG4gICAgICAgIC8vIG1vdmUgZG93blxuICAgICAgICB0aGlzLmJvZHkudmVsb2NpdHkueSA9ICt0aGlzLndhbGtpbmdfc3BlZWQ7XG4gICAgICAgIGlmICh0aGlzLmJvZHkudmVsb2NpdHkueCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5hbmltYXRpb25zLnBsYXkoXCJ3YWxraW5nX2Rvd25cIik7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmJvZHkudmVsb2NpdHkueSA9IDA7XG4gICAgfVxuICAgIFxuICAgIGlmICh0aGlzLmJvZHkudmVsb2NpdHkueCA9PT0gMCAmJiB0aGlzLmJvZHkudmVsb2NpdHkueSA9PT0gMCkge1xuICAgICAgICAvLyBzdG9wIGN1cnJlbnQgYW5pbWF0aW9uXG4gICAgICAgIHRoaXMuYW5pbWF0aW9ucy5zdG9wKCk7XG4gICAgICAgIHRoaXMuZnJhbWUgPSB0aGlzLnN0b3BwZWRfZnJhbWVzW3RoaXMuYm9keS5mYWNpbmddO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUGxheWVyOyIsInZhciBCYXR0bGVTdGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBQaGFzZXIuU3RhdGUuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMucHJlZmFiX2NsYXNzZXMgPSB7XG4gICAgICAgIFwiYmFja2dyb3VuZFwiOiByZXF1aXJlKCcuLy4uL3ByZWZhYnMvVGlsZVByZWZhYicpLnByb3RvdHlwZS5jb25zdHJ1Y3RvcixcbiAgICAgICAgXCJyZWN0YW5nbGVcIjogcmVxdWlyZSgnLi8uLi9wcmVmYWJzL1ByZWZhYicpLnByb3RvdHlwZS5jb25zdHJ1Y3RvcixcbiAgICAgICAgXCJwbGF5ZXJfdW5pdFwiOiByZXF1aXJlKCcuLy4uL3ByZWZhYnMvVW5pdHMvUGxheWVyVW5pdCcpLnByb3RvdHlwZS5jb25zdHJ1Y3RvcixcbiAgICAgICAgXCJlbmVteV91bml0XCI6IHJlcXVpcmUoJy4vLi4vcHJlZmFicy9Vbml0cy9FbmVteVVuaXQnKS5wcm90b3R5cGUuY29uc3RydWN0b3IsXG4gICAgICAgIFwiaW52ZW50b3J5XCI6IHJlcXVpcmUoJy4vLi4vcHJlZmFicy9pdGVtcy9JbnZlbnRvcnknKS5wcm90b3R5cGUuY29uc3RydWN0b3JcbiAgICB9O1xuXG4gICAgdGhpcy5URVhUX1NUWUxFID0ge2ZvbnQ6IFwiMTRweCBBcmlhbFwiLCBmaWxsOiBcIiNGRkZGRkZcIn07XG59O1xuXG5CYXR0bGVTdGF0ZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBoYXNlci5TdGF0ZS5wcm90b3R5cGUpO1xuQmF0dGxlU3RhdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQmF0dGxlU3RhdGU7XG5cbkJhdHRsZVN0YXRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGxldmVsX2RhdGEsIGV4dHJhX3BhcmFtZXRlcnMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBjb25zb2xlLmxvZyhcImluaXRcIik7XG4gICAgdGhpcy5sZXZlbF9kYXRhID0gbGV2ZWxfZGF0YTtcbiAgICB0aGlzLmVuY291bnRlciA9IGV4dHJhX3BhcmFtZXRlcnMuZW5jb3VudGVyO1xuICAgIHRoaXMucGFydHlfZGF0YSA9IGV4dHJhX3BhcmFtZXRlcnMucGFydHlfZGF0YTtcbiAgICB0aGlzLmludmVudG9yeSA9IGV4dHJhX3BhcmFtZXRlcnMuaW52ZW50b3J5O1xuXG5cbiAgICB0aGlzLnNjYWxlLnNjYWxlTW9kZSA9IFBoYXNlci5TY2FsZU1hbmFnZXIuU0hPV19BTEw7XG4gICAgdGhpcy5zY2FsZS5wYWdlQWxpZ25Ib3Jpem9udGFsbHkgPSB0cnVlO1xuICAgIHRoaXMuc2NhbGUucGFnZUFsaWduVmVydGljYWxseSA9IHRydWU7XG59O1xuXG5CYXR0bGVTdGF0ZS5wcm90b3R5cGUucHJlbG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBjb25zb2xlLmxvZyhcInByZWxvYWRcIik7XG4gICAgdGhpcy5sb2FkLnRleHQoXCJleHBlcmllbmNlX3RhYmxlXCIsIFwiYXNzZXRzL2xldmVscy9leHBlcmllbmNlX3RhYmxlLmpzb25cIik7XG59O1xuXG5CYXR0bGVTdGF0ZS5wcm90b3R5cGUuY3JlYXRlID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIGNvbnNvbGUubG9nKFwiY3JlYXRlXCIpO1xuICAgIHZhciBncm91cF9uYW1lLCBwcmVmYWJfbmFtZSwgcGxheWVyX3VuaXRfbmFtZSwgZW5lbXlfdW5pdF9uYW1lO1xuXG4gICAgLy8gY3JlYXRlIGdyb3Vwc1xuICAgIHRoaXMuZ3JvdXBzID0ge307XG4gICAgdGhpcy5sZXZlbF9kYXRhLmdyb3Vwcy5mb3JFYWNoKGZ1bmN0aW9uIChncm91cF9uYW1lKSB7XG4gICAgICAgIHRoaXMuZ3JvdXBzW2dyb3VwX25hbWVdID0gdGhpcy5nYW1lLmFkZC5ncm91cCgpO1xuICAgIH0sIHRoaXMpO1xuXG4gICAgLy8gY3JlYXRlIHByZWZhYnNcbiAgICB0aGlzLnByZWZhYnMgPSB7fTtcbiAgICBmb3IgKHByZWZhYl9uYW1lIGluIHRoaXMubGV2ZWxfZGF0YS5wcmVmYWJzKSB7XG4gICAgICAgIGlmICh0aGlzLmxldmVsX2RhdGEucHJlZmFicy5oYXNPd25Qcm9wZXJ0eShwcmVmYWJfbmFtZSkpIHtcbiAgICAgICAgICAgIC8vIGNyZWF0ZSBwcmVmYWJcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlX3ByZWZhYihwcmVmYWJfbmFtZSwgdGhpcy5sZXZlbF9kYXRhLnByZWZhYnNbcHJlZmFiX25hbWVdKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIGlmIHRoZXJlIGlzIG5vIGludmVudG9yeSBmcm9tIFdvcmxkU3RhdGUsIGNyZWF0ZSBhbiBlbXB0eSBvbmVcbiAgICBpZiAodGhpcy5pbnZlbnRvcnkpIHtcbiAgICAgICAgdGhpcy5wcmVmYWJzLmludmVudG9yeSA9IHRoaXMuaW52ZW50b3J5O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBpbnYgPSByZXF1aXJlKCcuLy4uL3ByZWZhYnMvaXRlbXMvSW52ZW50b3J5Jyk7XG4gICAgICAgIHRoaXMucHJlZmFicy5pbnZlbnRvcnkgPSBuZXcgaW52KHRoaXMsIFwiaW52ZW50b3J5XCIsIHt4OiAwLCB5OiAwfSwge2dyb3VwOiBcIml0ZW1zXCJ9KTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgZW5lbXkgdW5pdHNcbiAgICBmb3IgKGVuZW15X3VuaXRfbmFtZSBpbiB0aGlzLmVuY291bnRlci5lbmVteV9kYXRhKSB7XG4gICAgICAgIGlmICh0aGlzLmVuY291bnRlci5lbmVteV9kYXRhLmhhc093blByb3BlcnR5KGVuZW15X3VuaXRfbmFtZSkpIHtcbiAgICAgICAgICAgIC8vIGNyZWF0ZSBlbmVteSB1bml0c1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVfcHJlZmFiKGVuZW15X3VuaXRfbmFtZSwgdGhpcy5lbmNvdW50ZXIuZW5lbXlfZGF0YVtlbmVteV91bml0X25hbWVdKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIGNyZWF0ZSBwbGF5ZXIgdW5pdHNcbiAgICBmb3IgKHBsYXllcl91bml0X25hbWUgaW4gdGhpcy5wYXJ0eV9kYXRhKSB7XG4gICAgICAgIGlmICh0aGlzLnBhcnR5X2RhdGEuaGFzT3duUHJvcGVydHkocGxheWVyX3VuaXRfbmFtZSkpIHtcbiAgICAgICAgICAgIC8vIGNyZWF0ZSBwbGF5ZXIgdW5pdHNcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlX3ByZWZhYihwbGF5ZXJfdW5pdF9uYW1lLCB0aGlzLnBhcnR5X2RhdGFbcGxheWVyX3VuaXRfbmFtZV0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gc2F2ZSBleHBlcmllbmNlIHRhYmxlXG4gICAgdGhpcy5leHBlcmllbmNlX3RhYmxlID0gSlNPTi5wYXJzZSh0aGlzLmdhbWUuY2FjaGUuZ2V0VGV4dChcImV4cGVyaWVuY2VfdGFibGVcIikpO1xuXG4gICAgdGhpcy5pbml0X2h1ZCgpO1xuXG4gICAgLy8gc3RvcmUgdW5pdHMgaW4gYSBwcmlvcml0eSBxdWV1ZSB3aGljaCBjb21wYXJlcyB0aGUgdW5pdHMgYWN0IHR1cm5cbiAgICB0aGlzLnVuaXRzID0gbmV3IFByaW9yaXR5UXVldWUoe1xuICAgICAgICBjb21wYXJhdG9yOiBmdW5jdGlvbiAodW5pdF9hLCB1bml0X2IpIHtcbiAgICAgICAgICAgIHJldHVybiB1bml0X2EuYWN0X3R1cm4gLSB1bml0X2IuYWN0X3R1cm47XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLmdyb3Vwcy5wbGF5ZXJfdW5pdHMuZm9yRWFjaChmdW5jdGlvbiAodW5pdCkge1xuICAgICAgICB1bml0LmNhbGN1bGF0ZV9hY3RfdHVybigwKTtcbiAgICAgICAgdGhpcy51bml0cy5xdWV1ZSh1bml0KTtcbiAgICB9LCB0aGlzKTtcbiAgICB0aGlzLmdyb3Vwcy5lbmVteV91bml0cy5mb3JFYWNoKGZ1bmN0aW9uICh1bml0KSB7XG4gICAgICAgIHVuaXQuY2FsY3VsYXRlX2FjdF90dXJuKDApO1xuICAgICAgICB0aGlzLnVuaXRzLnF1ZXVlKHVuaXQpO1xuICAgIH0sIHRoaXMpO1xuXG4gICAgdGhpcy5uZXh0X3R1cm4oKTtcbn07XG5cbkJhdHRsZVN0YXRlLnByb3RvdHlwZS5jcmVhdGVfcHJlZmFiID0gZnVuY3Rpb24gKHByZWZhYl9uYW1lLCBwcmVmYWJfZGF0YSkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBwcmVmYWI7XG4gICAgLy8gY3JlYXRlIG9iamVjdCBhY2NvcmRpbmcgdG8gaXRzIHR5cGVcbiAgICBpZiAodGhpcy5wcmVmYWJfY2xhc3Nlcy5oYXNPd25Qcm9wZXJ0eShwcmVmYWJfZGF0YS50eXBlKSkge1xuICAgICAgICBwcmVmYWIgPSBuZXcgdGhpcy5wcmVmYWJfY2xhc3Nlc1twcmVmYWJfZGF0YS50eXBlXSh0aGlzLCBwcmVmYWJfbmFtZSwgcHJlZmFiX2RhdGEucG9zaXRpb24sIHByZWZhYl9kYXRhLnByb3BlcnRpZXMpO1xuICAgIH1cbn07XG5cbkJhdHRsZVN0YXRlLnByb3RvdHlwZS5pbml0X2h1ZCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgdW5pdF9pbmRleCwgcGxheWVyX3VuaXRfaGVhbHRoO1xuXG4gICAgLy8gc2hvdyBwbGF5ZXIgYWN0aW9uc1xuICAgIHRoaXMuc2hvd19wbGF5ZXJfYWN0aW9ucyh7eDogMTA2LCB5OiAyMTB9KTtcblxuICAgIC8vIHNob3cgcGxheWVyIHVuaXRzXG4gICAgdGhpcy5zaG93X3VuaXRzKFwicGxheWVyX3VuaXRzXCIsIHt4OiAyMDIsIHk6IDIxMH0sIHJlcXVpcmUoJy4vLi4vcHJlZmFicy9IVUQvUGxheWVyTWVudUl0ZW0nKS5wcm90b3R5cGUuY29uc3RydWN0b3IpO1xuXG4gICAgLy8gc2hvdyBlbmVteSB1bml0c1xuICAgIHRoaXMuc2hvd191bml0cyhcImVuZW15X3VuaXRzXCIsIHt4OiAxMCwgeTogMjEwfSwgcmVxdWlyZSgnLi8uLi9wcmVmYWJzL0hVRC9FbmVteU1lbnVJdGVtJykucHJvdG90eXBlLmNvbnN0cnVjdG9yKTtcblxuICAgIC8vIGNyZWF0ZSBpdGVtcyBtZW51XG4gICAgdGhpcy5wcmVmYWJzLmludmVudG9yeS5jcmVhdGVfbWVudSh7eDogMTA2LCB5OiAyMTB9KTtcbn07XG5cbkJhdHRsZVN0YXRlLnByb3RvdHlwZS5zaG93X3VuaXRzID0gZnVuY3Rpb24gKGdyb3VwX25hbWUsIHBvc2l0aW9uLCBtZW51X2l0ZW1fY29uc3RydWN0b3IpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgdW5pdF9pbmRleCwgbWVudV9pdGVtcywgdW5pdF9tZW51X2l0ZW0sIHVuaXRzX21lbnU7XG5cbiAgICAvLyBjcmVhdGUgdW5pdHMgbWVudSBpdGVtc1xuICAgIHVuaXRfaW5kZXggPSAwO1xuICAgIG1lbnVfaXRlbXMgPSBbXTtcbiAgICB0aGlzLmdyb3Vwc1tncm91cF9uYW1lXS5mb3JFYWNoKGZ1bmN0aW9uICh1bml0KSB7XG4gICAgICAgIHVuaXRfbWVudV9pdGVtID0gbmV3IG1lbnVfaXRlbV9jb25zdHJ1Y3Rvcih0aGlzLCB1bml0Lm5hbWUgKyBcIl9tZW51X2l0ZW1cIiwge1xuICAgICAgICAgICAgeDogcG9zaXRpb24ueCxcbiAgICAgICAgICAgIHk6IHBvc2l0aW9uLnkgKyB1bml0X2luZGV4ICogMjBcbiAgICAgICAgfSwge2dyb3VwOiBcImh1ZFwiLCB0ZXh0OiB1bml0Lm5hbWUsIHN0eWxlOiBPYmplY3QuY3JlYXRlKHRoaXMuVEVYVF9TVFlMRSl9KTtcbiAgICAgICAgdW5pdF9pbmRleCArPSAxO1xuICAgICAgICBtZW51X2l0ZW1zLnB1c2godW5pdF9tZW51X2l0ZW0pO1xuICAgIH0sIHRoaXMpO1xuICAgIC8vIGNyZWF0ZSB1bml0cyBtZW51XG4gICAgdmFyIG1lbnUgPSByZXF1aXJlKCcuLy4uL3ByZWZhYnMvSFVEL01lbnUnKTtcbiAgICB1bml0c19tZW51ID0gbmV3IG1lbnUodGhpcywgZ3JvdXBfbmFtZSArIFwiX21lbnVcIiwgcG9zaXRpb24sIHtncm91cDogXCJodWRcIiwgbWVudV9pdGVtczogbWVudV9pdGVtc30pO1xufTtcblxuQmF0dGxlU3RhdGUucHJvdG90eXBlLnNob3dfcGxheWVyX2FjdGlvbnMgPSBmdW5jdGlvbiAocG9zaXRpb24pIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgYWN0aW9ucywgYWN0aW9uc19tZW51X2l0ZW1zLCBhY3Rpb25faW5kZXgsIGFjdGlvbnNfbWVudTtcbiAgICAvLyBhdmFpbGFibGUgYWN0aW9uc1xuICAgIGFjdGlvbnMgPSBbXG4gICAgICAgIHt0ZXh0OiBcIkF0dGFja1wiLCBpdGVtX2NvbnN0cnVjdG9yOiByZXF1aXJlKCcuLy4uL3ByZWZhYnMvSFVEL0F0dGFja01lbnVJdGVtJykucHJvdG90eXBlLmNvbnN0cnVjdG9yfSxcbiAgICAgICAge3RleHQ6IFwiTWFnaWNcIiwgaXRlbV9jb25zdHJ1Y3RvcjogcmVxdWlyZSgnLi8uLi9wcmVmYWJzL0hVRC9NYWdpY0F0dGFja01lbnVJdGVtJykucHJvdG90eXBlLmNvbnN0cnVjdG9yfSxcbiAgICAgICAge3RleHQ6IFwiSXRlbVwiLCBpdGVtX2NvbnN0cnVjdG9yOiByZXF1aXJlKCcuLy4uL3ByZWZhYnMvSFVEL0ludmVudG9yeU1lbnVJdGVtJykucHJvdG90eXBlLmNvbnN0cnVjdG9yfVxuICAgIF07XG4gICAgYWN0aW9uc19tZW51X2l0ZW1zID0gW107XG4gICAgYWN0aW9uX2luZGV4ID0gMDtcbiAgICAvLyBjcmVhdGUgYSBtZW51IGl0ZW0gZm9yIGVhY2ggYWN0aW9uXG4gICAgYWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChhY3Rpb24pIHtcbiAgICAgICAgYWN0aW9uc19tZW51X2l0ZW1zLnB1c2gobmV3IGFjdGlvbi5pdGVtX2NvbnN0cnVjdG9yKHRoaXMsIGFjdGlvbi50ZXh0ICsgXCJfbWVudV9pdGVtXCIsIHtcbiAgICAgICAgICAgIHg6IHBvc2l0aW9uLngsXG4gICAgICAgICAgICB5OiBwb3NpdGlvbi55ICsgYWN0aW9uX2luZGV4ICogMjBcbiAgICAgICAgfSwge2dyb3VwOiBcImh1ZFwiLCB0ZXh0OiBhY3Rpb24udGV4dCwgc3R5bGU6IE9iamVjdC5jcmVhdGUodGhpcy5URVhUX1NUWUxFKX0pKTtcbiAgICAgICAgYWN0aW9uX2luZGV4ICs9IDE7XG4gICAgfSwgdGhpcyk7XG4gICAgdmFyIG1lbnUgPSByZXF1aXJlKCcuLy4uL3ByZWZhYnMvSFVEL01lbnUnKTtcbiAgICBhY3Rpb25zX21lbnUgPSBuZXcgbWVudSh0aGlzLCBcImFjdGlvbnNfbWVudVwiLCBwb3NpdGlvbiwge2dyb3VwOiBcImh1ZFwiLCBtZW51X2l0ZW1zOiBhY3Rpb25zX21lbnVfaXRlbXN9KTtcbn07XG5cbkJhdHRsZVN0YXRlLnByb3RvdHlwZS5uZXh0X3R1cm4gPSBmdW5jdGlvbiAoKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgLy8gaWYgYWxsIGVuZW15IHVuaXRzIGFyZSBkZWFkLCBnbyBiYWNrIHRvIHRoZSB3b3JsZCBzdGF0ZVxuICAgIGNvbnNvbGUubG9nKHRoaXMuZ3JvdXBzKTtcbiAgICBpZiAodGhpcy5ncm91cHMuZW5lbXlfdW5pdHMuY291bnRMaXZpbmcoKSA9PT0gMCkge1xuICAgICAgICB0aGlzLmVuZF9iYXR0bGUoKTtcbiAgICB9XG5cbiAgICAvLyBpZiBhbGwgcGxheWVyIHVuaXRzIGFyZSBkZWFkLCByZXN0YXJ0IHRoZSBnYW1lXG4gICAgaWYgKHRoaXMuZ3JvdXBzLnBsYXllcl91bml0cy5jb3VudExpdmluZygpID09PSAwKSB7XG4gICAgICAgIHRoaXMuZ2FtZV9vdmVyKCk7XG4gICAgfVxuXG4gICAgLy8gdGFrZXMgdGhlIG5leHQgdW5pdFxuICAgIHRoaXMuY3VycmVudF91bml0ID0gdGhpcy51bml0cy5kZXF1ZXVlKCk7XG4gICAgLy8gaWYgdGhlIHVuaXQgaXMgYWxpdmUsIGl0IGFjdHMsIG90aGVyd2lzZSBnb2VzIHRvIHRoZSBuZXh0IHR1cm5cbiAgICBpZiAodGhpcy5jdXJyZW50X3VuaXQuYWxpdmUpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50X3VuaXQuYWN0KCk7XG4gICAgICAgIHRoaXMuY3VycmVudF91bml0LmNhbGN1bGF0ZV9hY3RfdHVybih0aGlzLmN1cnJlbnRfdW5pdC5hY3RfdHVybik7XG4gICAgICAgIHRoaXMudW5pdHMucXVldWUodGhpcy5jdXJyZW50X3VuaXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubmV4dF90dXJuKCk7XG4gICAgfVxufTtcblxuQmF0dGxlU3RhdGUucHJvdG90eXBlLmdhbWVfb3ZlciA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBjb25zb2xlLmxvZyhcIkdBTUVfT1ZFUlwiKTtcbiAgICAvLyBnbyBiYWNrIHRvIFdvcmxkU3RhdGUgcmVzdGFydGluZyB0aGUgcGxheWVyIHBvc2l0aW9uXG4gICAgdGhpcy5nYW1lLnN0YXRlLnN0YXJ0KFwiQm9vdFN0YXRlXCIsIHRydWUsIGZhbHNlLCBcImFzc2V0cy9sZXZlbHMvbGV2ZWwxLmpzb25cIiwgXCJXb3JsZFN0YXRlXCIsIHtyZXN0YXJ0X3Bvc2l0aW9uOiB0cnVlfSk7XG59O1xuXG5CYXR0bGVTdGF0ZS5wcm90b3R5cGUuZW5kX2JhdHRsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgcmVjZWl2ZWRfZXhwZXJpZW5jZSA9IHRoaXMuZW5jb3VudGVyLnJld2FyZC5leHBlcmllbmNlO1xuICAgIHRoaXMuZ3JvdXBzLnBsYXllcl91bml0cy5mb3JFYWNoKGZ1bmN0aW9uIChwbGF5ZXJfdW5pdCkge1xuICAgICAgICAvLyByZWNlaXZlIGV4cGVyaWVuY2UgZnJvbSBlbmVteVxuICAgICAgICBwbGF5ZXJfdW5pdC5yZWNlaXZlX2V4cGVyaWVuY2UocmVjZWl2ZWRfZXhwZXJpZW5jZSAvIHRoaXMuZ3JvdXBzLnBsYXllcl91bml0cy5jaGlsZHJlbi5sZW5ndGgpO1xuICAgICAgICAvLyBzYXZlIGN1cnJlbnQgcGFydHkgc3RhdHNcbiAgICAgICAgdGhpcy5wYXJ0eV9kYXRhW3BsYXllcl91bml0Lm5hbWVdLnByb3BlcnRpZXMuc3RhdHMgPSBwbGF5ZXJfdW5pdC5zdGF0cztcbiAgICB9LCB0aGlzKTtcblxuXG4gICAgdGhpcy5lbmNvdW50ZXIucmV3YXJkLml0ZW1zLmZvckVhY2goZnVuY3Rpb24gKGl0ZW1fb2JqZWN0KSB7XG4gICAgICAgIHRoaXMucHJlZmFicy5pbnZlbnRvcnkuY29sbGVjdF9pdGVtKGl0ZW1fb2JqZWN0KTtcbiAgICB9LCB0aGlzKTtcblxuICAgIGNvbnNvbGUubG9nKFwiQkFUVExFIFdPTlwiKTtcbiAgICAvLyBnbyBiYWNrIHRvIFdvcmxkU3RhdGUgd2l0aCB0aGUgY3VycmVudCBwYXJ0eSBkYXRhXG4gICAgdGhpcy5nYW1lLnN0YXRlLnN0YXJ0KFwiQm9vdFN0YXRlXCIsIHRydWUsIGZhbHNlLCBcImFzc2V0cy9sZXZlbHMvbGV2ZWwxLmpzb25cIiwgXCJXb3JsZFN0YXRlXCIsIHtcbiAgICAgICAgcGFydHlfZGF0YTogdGhpcy5wYXJ0eV9kYXRhLFxuICAgICAgICBpbnZlbnRvcnk6IHRoaXMucHJlZmFicy5pbnZlbnRvcnlcbiAgICB9KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gQmF0dGxlU3RhdGU7XG4iLCJ2YXIgQm9vdFN0YXRlID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIFBoYXNlci5TdGF0ZS5jYWxsKHRoaXMpO1xufTtcblxuQm9vdFN0YXRlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUGhhc2VyLlN0YXRlLnByb3RvdHlwZSk7XG5Cb290U3RhdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQm9vdFN0YXRlO1xuXG5Cb290U3RhdGUucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAobGV2ZWxfZmlsZSwgbmV4dF9zdGF0ZSwgZXh0cmFfcGFyYW1ldGVycykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHRoaXMubGV2ZWxfZmlsZSA9IGxldmVsX2ZpbGU7XG4gICAgdGhpcy5uZXh0X3N0YXRlID0gbmV4dF9zdGF0ZTtcbiAgICB0aGlzLmV4dHJhX3BhcmFtZXRlcnMgPSBleHRyYV9wYXJhbWV0ZXJzO1xufTtcblxuQm9vdFN0YXRlLnByb3RvdHlwZS5wcmVsb2FkID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHRoaXMubG9hZC50ZXh0KFwibGV2ZWwxXCIsIHRoaXMubGV2ZWxfZmlsZSk7XG59O1xuXG5Cb290U3RhdGUucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgbGV2ZWxfdGV4dCA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRUZXh0KFwibGV2ZWwxXCIpO1xuICAgIHZhciBsZXZlbF9kYXRhID0gSlNPTi5wYXJzZShsZXZlbF90ZXh0KTtcbiAgICB0aGlzLmdhbWUuc3RhdGUuc3RhcnQoXCJMb2FkaW5nU3RhdGVcIiwgdHJ1ZSwgZmFsc2UsIGxldmVsX2RhdGEsIHRoaXMubmV4dF9zdGF0ZSwgdGhpcy5leHRyYV9wYXJhbWV0ZXJzKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gQm9vdFN0YXRlO1xuIiwidmFyIExvYWRpbmdTdGF0ZSA9IGZ1bmN0aW9uICgpIHt9O1xuXG5cbkxvYWRpbmdTdGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBQaGFzZXIuU3RhdGUuY2FsbCh0aGlzKTtcbn07XG5cbkxvYWRpbmdTdGF0ZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBoYXNlci5TdGF0ZS5wcm90b3R5cGUpO1xuTG9hZGluZ1N0YXRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IExvYWRpbmdTdGF0ZTtcblxuTG9hZGluZ1N0YXRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGxldmVsX2RhdGEsIG5leHRfc3RhdGUsIGV4dHJhX3BhcmFtZXRlcnMpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB0aGlzLmxldmVsX2RhdGEgPSBsZXZlbF9kYXRhO1xuICAgIHRoaXMubmV4dF9zdGF0ZSA9IG5leHRfc3RhdGU7XG4gICAgdGhpcy5leHRyYV9wYXJhbWV0ZXJzID0gZXh0cmFfcGFyYW1ldGVycztcbn07XG5cbkxvYWRpbmdTdGF0ZS5wcm90b3R5cGUucHJlbG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5sZXZlbF9kYXRhLmFzc2V0cztcbiAgICBmb3IgKHZhciBhc3NldF9rZXkgaW4gYXNzZXRzKSB7IC8vIGxvYWQgYXNzZXRzIGFjY29yZGluZyB0byBhc3NldCBrZXlcbiAgICAgICAgaWYgKGFzc2V0cy5oYXNPd25Qcm9wZXJ0eShhc3NldF9rZXkpKSB7XG4gICAgICAgICAgICB2YXIgYXNzZXQgPSBhc3NldHNbYXNzZXRfa2V5XTtcbiAgICAgICAgICAgIHN3aXRjaCAoYXNzZXQudHlwZSkge1xuICAgICAgICAgICAgY2FzZSBcImltYWdlXCI6XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkLmltYWdlKGFzc2V0X2tleSwgYXNzZXQuc291cmNlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJzcHJpdGVzaGVldFwiOlxuICAgICAgICAgICAgICAgIHRoaXMubG9hZC5zcHJpdGVzaGVldChhc3NldF9rZXksIGFzc2V0LnNvdXJjZSwgYXNzZXQuZnJhbWVfd2lkdGgsIGFzc2V0LmZyYW1lX2hlaWdodCwgYXNzZXQuZnJhbWVzLCBhc3NldC5tYXJnaW4sIGFzc2V0LnNwYWNpbmcpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcInRpbGVtYXBcIjpcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWQudGlsZW1hcChhc3NldF9rZXksIGFzc2V0LnNvdXJjZSwgbnVsbCwgUGhhc2VyLlRpbGVtYXAuVElMRURfSlNPTik7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5Mb2FkaW5nU3RhdGUucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB0aGlzLmdhbWUuc3RhdGUuc3RhcnQodGhpcy5uZXh0X3N0YXRlLCB0cnVlLCBmYWxzZSwgdGhpcy5sZXZlbF9kYXRhLCB0aGlzLmV4dHJhX3BhcmFtZXRlcnMpO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBMb2FkaW5nU3RhdGU7XG4iLCJ2YXIgV29ybGRTdGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBQaGFzZXIuU3RhdGUuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMucHJlZmFiX2NsYXNzZXMgPSB7XG4gICAgICAgIFwicGxheWVyXCI6IHJlcXVpcmUoJy4vLi4vcHJlZmFicy93b3JsZC9QbGF5ZXInKS5wcm90b3R5cGUuY29uc3RydWN0b3IsXG4gICAgICAgIFwiZW5lbXlfc3Bhd25lclwiOiByZXF1aXJlKCcuLy4uL3ByZWZhYnMvd29ybGQvRW5lbXlTcGF3bmVyJykucHJvdG90eXBlLmNvbnN0cnVjdG9yXG4gICAgfTtcbn07XG5cbldvcmxkU3RhdGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuU3RhdGUucHJvdG90eXBlKTtcbldvcmxkU3RhdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV29ybGRTdGF0ZTtcblxuV29ybGRTdGF0ZS5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChsZXZlbF9kYXRhLCBleHRyYV9wYXJhbWV0ZXJzKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIHRpbGVzZXRfaW5kZXg7XG4gICAgdGhpcy5sZXZlbF9kYXRhID0gdGhpcy5sZXZlbF9kYXRhIHx8IGxldmVsX2RhdGE7XG5cbiAgICB0aGlzLnNjYWxlLnNjYWxlTW9kZSA9IFBoYXNlci5TY2FsZU1hbmFnZXIuU0hPV19BTEw7XG4gICAgdGhpcy5zY2FsZS5wYWdlQWxpZ25Ib3Jpem9udGFsbHkgPSB0cnVlO1xuICAgIHRoaXMuc2NhbGUucGFnZUFsaWduVmVydGljYWxseSA9IHRydWU7XG5cbiAgICAvLyBzdGFydCBwaHlzaWNzIHN5c3RlbVxuICAgIHRoaXMuZ2FtZS5waHlzaWNzLnN0YXJ0U3lzdGVtKFBoYXNlci5QaHlzaWNzLkFSQ0FERSk7XG4gICAgdGhpcy5nYW1lLnBoeXNpY3MuYXJjYWRlLmdyYXZpdHkueSA9IDA7XG5cbiAgICAvLyBjcmVhdGUgbWFwIGFuZCBzZXQgdGlsZXNldFxuICAgIHRoaXMubWFwID0gdGhpcy5nYW1lLmFkZC50aWxlbWFwKHRoaXMubGV2ZWxfZGF0YS5tYXAua2V5KTtcbiAgICB0aWxlc2V0X2luZGV4ID0gMDtcbiAgICB0aGlzLm1hcC50aWxlc2V0cy5mb3JFYWNoKGZ1bmN0aW9uICh0aWxlc2V0KSB7XG4gICAgICAgIHRoaXMubWFwLmFkZFRpbGVzZXRJbWFnZSh0aWxlc2V0Lm5hbWUsIHRoaXMubGV2ZWxfZGF0YS5tYXAudGlsZXNldHNbdGlsZXNldF9pbmRleF0pO1xuICAgICAgICB0aWxlc2V0X2luZGV4ICs9IDE7XG4gICAgfSwgdGhpcyk7XG5cbiAgICAvLyBpZiBubyBwYXJ0eSBkYXRhIGlzIGluIHRoZSBwYXJhbWV0ZXJzLCBpbml0aWFsaXplIGl0IHdpdGggZGVmYXVsdCB2YWx1ZXNcbiAgICB0aGlzLnBhcnR5X2RhdGEgPSBleHRyYV9wYXJhbWV0ZXJzLnBhcnR5X2RhdGEgfHwge1xuICAgICAgICAgICAgXCJmaWdodGVyXCI6IHtcbiAgICAgICAgICAgICAgICBcInR5cGVcIjogXCJwbGF5ZXJfdW5pdFwiLFxuICAgICAgICAgICAgICAgIFwicG9zaXRpb25cIjoge1wieFwiOiAyNTAsIFwieVwiOiA1MH0sXG4gICAgICAgICAgICAgICAgXCJwcm9wZXJ0aWVzXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJ0ZXh0dXJlXCI6IFwibWFsZV9maWdodGVyX3Nwcml0ZXNoZWV0XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiZ3JvdXBcIjogXCJwbGF5ZXJfdW5pdHNcIixcbiAgICAgICAgICAgICAgICAgICAgXCJmcmFtZVwiOiAxMCxcbiAgICAgICAgICAgICAgICAgICAgXCJzdGF0c1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcImF0dGFja1wiOiAyMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibWFnaWNfYXR0YWNrXCI6IDUsXG4gICAgICAgICAgICAgICAgICAgICAgICBcImRlZmVuc2VcIjogNSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiaGVhbHRoXCI6IDEwMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibWFuYVwiOiAxMDAsXG4gICAgICAgICAgICAgICAgICAgICAgICBcInNwZWVkXCI6IDE1LFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJleHBlcmllbmNlXCI6IDAsXG4gICAgICAgICAgICAgICAgICAgICAgICBcImN1cnJlbnRfbGV2ZWxcIjogMFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibWFnZVwiOiB7XG4gICAgICAgICAgICAgICAgXCJ0eXBlXCI6IFwicGxheWVyX3VuaXRcIixcbiAgICAgICAgICAgICAgICBcInBvc2l0aW9uXCI6IHtcInhcIjogMjUwLCBcInlcIjogMTAwfSxcbiAgICAgICAgICAgICAgICBcInByb3BlcnRpZXNcIjoge1xuICAgICAgICAgICAgICAgICAgICBcInRleHR1cmVcIjogXCJmZW1hbGVfbWFnZV9zcHJpdGVzaGVldFwiLFxuICAgICAgICAgICAgICAgICAgICBcImdyb3VwXCI6IFwicGxheWVyX3VuaXRzXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiZnJhbWVcIjogMTAsXG4gICAgICAgICAgICAgICAgICAgIFwic3RhdHNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJhdHRhY2tcIjogNSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibWFnaWNfYXR0YWNrXCI6IDIwLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJkZWZlbnNlXCI6IDIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcImhlYWx0aFwiOiAxMDAsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIm1hbmFcIjogMTAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJzcGVlZFwiOiAxMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZXhwZXJpZW5jZVwiOiAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJjdXJyZW50X2xldmVsXCI6IDBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcInJhbmdlclwiOiB7XG4gICAgICAgICAgICAgICAgXCJ0eXBlXCI6IFwicGxheWVyX3VuaXRcIixcbiAgICAgICAgICAgICAgICBcInBvc2l0aW9uXCI6IHtcInhcIjogMjUwLCBcInlcIjogMTUwfSxcbiAgICAgICAgICAgICAgICBcInByb3BlcnRpZXNcIjoge1xuICAgICAgICAgICAgICAgICAgICBcInRleHR1cmVcIjogXCJmZW1hbGVfcmFuZ2VyX3Nwcml0ZXNoZWV0XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiZ3JvdXBcIjogXCJwbGF5ZXJfdW5pdHNcIixcbiAgICAgICAgICAgICAgICAgICAgXCJmcmFtZVwiOiAxMCxcbiAgICAgICAgICAgICAgICAgICAgXCJzdGF0c1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcImF0dGFja1wiOiAxMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibWFnaWNfYXR0YWNrXCI6IDEwLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJkZWZlbnNlXCI6IDMsXG4gICAgICAgICAgICAgICAgICAgICAgICBcImhlYWx0aFwiOiAxMDAsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIm1hbmFcIjogMTAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJzcGVlZFwiOiAyMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZXhwZXJpZW5jZVwiOiAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJjdXJyZW50X2xldmVsXCI6IDBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgIGlmIChleHRyYV9wYXJhbWV0ZXJzLnJlc3RhcnRfcG9zaXRpb24pIHtcbiAgICAgICAgdGhpcy5wbGF5ZXJfcG9zaXRpb24gPSB1bmRlZmluZWQ7XG4gICAgfVxufTtcblxuV29ybGRTdGF0ZS5wcm90b3R5cGUuY3JlYXRlID0gZnVuY3Rpb24gKCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBncm91cF9uYW1lLCBvYmplY3RfbGF5ZXIsIGNvbGxpc2lvbl90aWxlcztcblxuICAgIC8vIGNyZWF0ZSBtYXAgbGF5ZXJzXG4gICAgdGhpcy5sYXllcnMgPSB7fTtcbiAgICB0aGlzLm1hcC5sYXllcnMuZm9yRWFjaChmdW5jdGlvbiAobGF5ZXIpIHtcbiAgICAgICAgdGhpcy5sYXllcnNbbGF5ZXIubmFtZV0gPSB0aGlzLm1hcC5jcmVhdGVMYXllcihsYXllci5uYW1lKTtcbiAgICAgICAgaWYgKGxheWVyLnByb3BlcnRpZXMuY29sbGlzaW9uKSB7IC8vIGNvbGxpc2lvbiBsYXllclxuICAgICAgICAgICAgY29sbGlzaW9uX3RpbGVzID0gW107XG4gICAgICAgICAgICBsYXllci5kYXRhLmZvckVhY2goZnVuY3Rpb24gKGRhdGFfcm93KSB7IC8vIGZpbmQgdGlsZXMgdXNlZCBpbiB0aGUgbGF5ZXJcbiAgICAgICAgICAgICAgICBkYXRhX3Jvdy5mb3JFYWNoKGZ1bmN0aW9uICh0aWxlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGl0J3MgYSB2YWxpZCB0aWxlIGluZGV4IGFuZCBpc24ndCBhbHJlYWR5IGluIHRoZSBsaXN0XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aWxlLmluZGV4ID4gMCAmJiBjb2xsaXNpb25fdGlsZXMuaW5kZXhPZih0aWxlLmluZGV4KSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxpc2lvbl90aWxlcy5wdXNoKHRpbGUuaW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgdGhpcyk7XG4gICAgICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgICAgIHRoaXMubWFwLnNldENvbGxpc2lvbihjb2xsaXNpb25fdGlsZXMsIHRydWUsIGxheWVyLm5hbWUpO1xuICAgICAgICB9XG4gICAgfSwgdGhpcyk7XG4gICAgLy8gcmVzaXplIHRoZSB3b3JsZCB0byBiZSB0aGUgc2l6ZSBvZiB0aGUgY3VycmVudCBsYXllclxuICAgIHRoaXMubGF5ZXJzW3RoaXMubWFwLmxheWVyLm5hbWVdLnJlc2l6ZVdvcmxkKCk7XG5cbiAgICAvLyBjcmVhdGUgZ3JvdXBzXG4gICAgdGhpcy5ncm91cHMgPSB7fTtcbiAgICB0aGlzLmxldmVsX2RhdGEuZ3JvdXBzLmZvckVhY2goZnVuY3Rpb24gKGdyb3VwX25hbWUpIHtcbiAgICAgICAgdGhpcy5ncm91cHNbZ3JvdXBfbmFtZV0gPSB0aGlzLmdhbWUuYWRkLmdyb3VwKCk7XG4gICAgfSwgdGhpcyk7XG5cbiAgICB0aGlzLnByZWZhYnMgPSB7fTtcblxuICAgIGZvciAob2JqZWN0X2xheWVyIGluIHRoaXMubWFwLm9iamVjdHMpIHtcbiAgICAgICAgaWYgKHRoaXMubWFwLm9iamVjdHMuaGFzT3duUHJvcGVydHkob2JqZWN0X2xheWVyKSkge1xuICAgICAgICAgICAgLy8gY3JlYXRlIGxheWVyIG9iamVjdHNcbiAgICAgICAgICAgIHRoaXMubWFwLm9iamVjdHNbb2JqZWN0X2xheWVyXS5mb3JFYWNoKHRoaXMuY3JlYXRlX29iamVjdCwgdGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBjYW1lIGZyb20gQmF0dGxlU3RhdGUsIG1vdmUgdGhlIHBsYXllciB0byB0aGUgcHJldmlvdXMgcG9zaXRpb25cbiAgICBpZiAodGhpcy5wbGF5ZXJfcG9zaXRpb24pIHtcbiAgICAgICAgdGhpcy5wcmVmYWJzLnBsYXllci5yZXNldCh0aGlzLnBsYXllcl9wb3NpdGlvbi54LCB0aGlzLnBsYXllcl9wb3NpdGlvbi55KTtcbiAgICB9XG59O1xuXG5Xb3JsZFN0YXRlLnByb3RvdHlwZS5jcmVhdGVfb2JqZWN0ID0gZnVuY3Rpb24gKG9iamVjdCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBvYmplY3RfeSwgcG9zaXRpb24sIHByZWZhYjtcbiAgICAvLyB0aWxlZCBjb29yZGluYXRlcyBzdGFydHMgaW4gdGhlIGJvdHRvbSBsZWZ0IGNvcm5lclxuICAgIG9iamVjdF95ID0gKG9iamVjdC5naWQpID8gb2JqZWN0LnkgLSAodGhpcy5tYXAudGlsZUhlaWdodCAvIDIpIDogb2JqZWN0LnkgKyAob2JqZWN0LmhlaWdodCAvIDIpO1xuICAgIHBvc2l0aW9uID0ge1wieFwiOiBvYmplY3QueCArICh0aGlzLm1hcC50aWxlSGVpZ2h0IC8gMiksIFwieVwiOiBvYmplY3RfeX07XG4gICAgLy8gY3JlYXRlIG9iamVjdCBhY2NvcmRpbmcgdG8gaXRzIHR5cGVcbiAgICBpZiAodGhpcy5wcmVmYWJfY2xhc3Nlcy5oYXNPd25Qcm9wZXJ0eShvYmplY3QudHlwZSkpIHtcbiAgICAgICAgcHJlZmFiID0gbmV3IHRoaXMucHJlZmFiX2NsYXNzZXNbb2JqZWN0LnR5cGVdKHRoaXMsIG9iamVjdC5uYW1lLCBwb3NpdGlvbiwgb2JqZWN0LnByb3BlcnRpZXMpO1xuICAgIH1cbiAgICB0aGlzLnByZWZhYnNbb2JqZWN0Lm5hbWVdID0gcHJlZmFiO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBXb3JsZFN0YXRlO1xuXG4iXX0=
